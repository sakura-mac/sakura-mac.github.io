<!DOCTYPE html>


<html lang="en">


<head>
  <meta charset="utf-8" />
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    实验1：汇编，工具和引导 |  
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/images/ayer.png" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
  
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

  
  

  
<script>
var _hmt = _hmt || [];
(function() {
	var hm = document.createElement("script");
	hm.src = "https://hm.baidu.com/hm.js?41fc030db57d5570dd22f78997dc4a7e";
	var s = document.getElementsByTagName("script")[0]; 
	s.parentNode.insertBefore(hm, s);
})();
</script>


<link rel="alternate" href="/atom.xml" title="海猫栖息地" type="application/atom+xml">
</head>

</html>

<body>
  <div id="app">
    
      <canvas class="fireworks"></canvas>
      <style>
        .fireworks {
          position: fixed;
          left: 0;
          top: 0;
          z-index: 99999;
          pointer-events: none;
        }
      </style>
      
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-lab1"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  实验1：汇编，工具和引导
</h1>
 

    </header>
     
    <div class="article-meta">
      <a href="/2024/03/08/lab1/" class="article-date">
  <time datetime="2024-03-08T13:16:50.322Z" itemprop="datePublished">2024-03-08</time>
</a>   
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> Word count:</span>
            <span class="post-count">12.7k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> Reading time≈</span>
            <span class="post-count">60 min</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p>lab通关记录</p>
<a href="/2024/03/08/MIT-6.828%E5%AE%9E%E9%AA%8C%E9%80%9A%E5%85%B3%E8%AE%B0%E5%BD%95/" title="MIT-6.828实验通关记录">MIT-6.828实验通关记录</a>

<p>参考官网：<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2017/labs/lab1/">https://pdos.csail.mit.edu/6.828/2017/labs/lab1/</a></p>
<p>AT&amp;T汇编：<a target="_blank" rel="noopener" href="http://www.delorie.com/djgpp/doc/brennan/brennan_att_inline_djgpp.html">http://www.delorie.com/djgpp/doc/brennan/brennan_att_inline_djgpp.html</a></p>
<h2 id="启动操作系统"><a href="#启动操作系统" class="headerlink" title="启动操作系统"></a>启动操作系统</h2><p>安装lab的os：</p>
<span id="more"></span>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://pdos.csail.mit.edu/6.828/2017/jos.git lab</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#报错处理：fatal:unable to access &lt;url&gt; : server certificate...</span></span><br><span class="line"><span class="comment">#进入你的配置:</span></span><br><span class="line">vim ~/.zshrc</span><br><span class="line"><span class="comment">#或者</span></span><br><span class="line">vim ~/.bashrc</span><br><span class="line"><span class="comment">#添加以下代码来让你的电脑信任服务器</span></span><br><span class="line"><span class="built_in">export</span> GIT_SSL_NO_VERIFY=1</span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入lab目录</span></span><br><span class="line">make &amp;&amp; make qemu</span><br></pre></td></tr></table></figure>

<p>make之后最后一行出现代表os内核映像编译成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ mk obj/kern/kernel.img</span><br></pre></td></tr></table></figure>

<p>make qemu之后出现如下图说明qemu连接成功</p>
<p><img src="https://bed1.oss-cn-beijing.aliyuncs.com/202112211114666.png"></p>
<p>打开gdb查看bios</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#lab目录下</span></span><br><span class="line">make qemu-gdb</span><br><span class="line"><span class="comment">#再开一个相同路径的terminal</span></span><br><span class="line">make gdb</span><br><span class="line"><span class="comment">#si命令逐步执行</span></span><br><span class="line"><span class="comment">#关闭gdb：q</span></span><br><span class="line"><span class="comment">#关闭qemu-gdb：ctrl + A 和 X,需要注意ctrl 与 A同时按住抬起后再按X,不要三个键同时按</span></span><br></pre></td></tr></table></figure>

<h2 id="Part-1-PC-Bootstrap"><a href="#Part-1-PC-Bootstrap" class="headerlink" title="Part 1: PC Bootstrap"></a>Part 1: PC Bootstrap</h2><p>BIOS：Basic Input&#x2F;Output System</p>
<p>物理内存：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">+------------------+  &lt;- 0xFFFFFFFF (4GB)</span><br><span class="line">|      32-bit      |</span><br><span class="line">|  memory mapped   |</span><br><span class="line">|     devices      |</span><br><span class="line">|                  |</span><br><span class="line">/\/\/\/\/\/\/\/\/\/\</span><br><span class="line"></span><br><span class="line">/\/\/\/\/\/\/\/\/\/\</span><br><span class="line">|                  |</span><br><span class="line">|      Unused      |</span><br><span class="line">|                  |</span><br><span class="line">+------------------+  &lt;- depends on amount of RAM</span><br><span class="line">|                  |</span><br><span class="line">|                  |</span><br><span class="line">| Extended Memory  |</span><br><span class="line">|                  |</span><br><span class="line">|                  |</span><br><span class="line">+------------------+  &lt;- 0x00100000 (1MB)</span><br><span class="line">|     BIOS ROM     |</span><br><span class="line">+------------------+  &lt;- 0x000F0000 (960KB)</span><br><span class="line">|  16-bit devices, |</span><br><span class="line">|  expansion ROMs  |</span><br><span class="line">+------------------+  &lt;- 0x000C0000 (768KB)</span><br><span class="line">|   VGA Display    |</span><br><span class="line">+------------------+  &lt;- 0x000A0000 (640KB)</span><br><span class="line">|                  |</span><br><span class="line">|    Low Memory    |</span><br><span class="line">|                  |</span><br><span class="line">+------------------+  &lt;- 0x00000000</span><br></pre></td></tr></table></figure>

<p>可以看到bios从1MB结束，早期的PC如8088物理内存只有1MB（0x00000000-0x000fffff），现在这台x86扩展到了4GB。</p>
<p>打开gdb实际运行一些si命令（逐步执行机器码），可以看到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[f000:fff0]    0xffff0:	ljmp   <span class="variable">$0xf000</span>,<span class="variable">$0xe05b</span></span><br><span class="line"><span class="comment">#从接近bios顶部而不是960k地址进行长跳转到cs:0xf000(bios段基址),ip:0xe05b,反而往回跳</span></span><br><span class="line">0x0000fff0 <span class="keyword">in</span> ?? ()</span><br><span class="line">+ symbol-file obj/kern/kernel</span><br><span class="line">(gdb) si</span><br><span class="line">[f000:e05b]    0xfe05b:	cmpl   <span class="variable">$0x0</span>,%cs:0x6ac8</span><br><span class="line">0x0000e05b <span class="keyword">in</span> ?? ()</span><br></pre></td></tr></table></figure>

<p>实验指导告诉我，bios在长跳转之后进行中断描述符表（IDT）的初始化和VGA等各种devices等初始化，于是继续查看得到以下内容：发现存在关中断（clean）命令。</p>
<p><img src="https://bed1.oss-cn-beijing.aliyuncs.com/202112211114662.png"></p>
<p>然后接着BIOS读取boot loader，进行boot驱动</p>
<h2 id="Part-2-The-Boot-Loader"><a href="#Part-2-The-Boot-Loader" class="headerlink" title="Part 2: The Boot Loader"></a>Part 2: The Boot Loader</h2><p>硬盘或者软盘最小单位为扇区（sector），一个扇区512字节，如果硬盘可以boot，那么这第一个扇区叫做bootsector，存放了boot loader 代码。</p>
<p>bios通过读取bootsector进入内存，从0x7c00-0x7dff.当然，现在不止读取一个扇区，也不止硬盘&#x2F;软盘作为boot来源。</p>
<p>对于boot loader，实验已经准备好了boot&#x2F;boot.S和boot&#x2F;main.c来模拟。</p>
<p>对于boot loader，做两件事：</p>
<ol>
<li><p>从实模式到保护模式，即将物理内存从1MB扩展到4GB，这需要GDT</p>
</li>
<li><p>从硬盘，通过x86的已经写好的IO驱动来使用IDE设备寄存器，从第二个扇区开始读取内核代码（obj&#x2F;kern&#x2F;kernel.asm）</p>
</li>
</ol>
<h3 id="Exercise3"><a href="#Exercise3" class="headerlink" title="Exercise3"></a>Exercise3</h3><ol>
<li><p>通过GDB在boot入口0x7c00进行断点设置</p>
</li>
<li><p>看 <code>boot/boot.S</code>里的代码, 看 <code>obj/boot/boot.asm</code> 来确定地址. 显示 boot loader在GDB中反汇编命令,比较三种汇编代码差异</p>
</li>
<li><p>继续看boot&#x2F;main.c 代码执行readsect()，找到c对应的汇编代码，紧接着代码执行回到bootmain函数 , 找到for循环（读取剩余内核代码），在for循环结束地址设置断点，然后单步执行，看看最终会做什么</p>
</li>
</ol>
<p>回答以下问题:</p>
<ul>
<li><p>代码从哪里开始执行32位保护模式？是什么导致了16位到32位到转换？</p>
</li>
<li><p>boot loader最后一个指令是什么,kernel第一个指令是什么？</p>
</li>
<li><p>kernel第一条指令的地址?</p>
</li>
<li><p>boot loader如何决定读取内核的所有扇区?从哪里能找到信息?</p>
</li>
</ul>
<p>我们通过GDB来设置breakpoint来跟踪boot loader过程</p>
<p><img src="https://bed1.oss-cn-beijing.aliyuncs.com/202112211115296.png"></p>
<p>对比三个文件可以发现：GDB没有数据类型指定，如movb会执行为mov，同时boot.asm相较于boot.S少了头文件的引入标志，同时对于GDT只剩下CR0的开启</p>
<p>然后再看bootmain，调用两个函数：readseg和readsect</p>
<p>先定义了两个eh和eph，eph&#x3D;eh+程序num</p>
<p>然后从硬盘读一页，判定elf的魔数来决定内核是否合乎ELF格式，紧接着根据eph和eh使用for循环来加载剩余内核。</p>
<p>最后进入根据ELF节头表进入内核执行的entry</p>
<h3 id="Exercise4"><a href="#Exercise4" class="headerlink" title="Exercise4"></a>Exercise4</h3><ol>
<li><p>推荐阅读有关C指针内容：<em>C Programming Language</em> by Brian Kernighanand Dennis Ritchie (known as ‘K&amp;R’)</p>
</li>
<li><p>阅读从5.1到5.5，下载运行<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2017/labs/lab1/pointers.c">以下C程序</a>，确保你懂了所有输出结果原因，给出以下标准</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.第一到第六行的输出地址</span><br><span class="line">2.第二到第四行输出结果</span><br><span class="line">3.第五行为什么输出错误</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里还有一个<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2017/readings/pointers.pdf">参考</a>，不过不是很推荐</p>
</li>
<li><p>这个阅读实验一定要做，否则后续的代码编写，你会知道什么叫做 “残忍”</p>
</li>
<li><p>可以从本人的关键文件注释下参考代码解读</p>
</li>
</ol>
<h3 id="Exercise5"><a href="#Exercise5" class="headerlink" title="Exercise5"></a>Exercise5</h3><ol>
<li><p>重新看boot loader开始一部分代码，如果你修改链接地址，那么会有一些错误，找到关于链接地址的错误，在boot&#x2F;Makefrag里面修改</p>
</li>
<li><p>使用make clean清除上次make缓存</p>
</li>
<li><p>重新编译，运行代码，解释发生的错误情况</p>
</li>
</ol>
<p>这里对于boot loader再做一些讲解，在main.c里面非常重要的就是那个ELFHDR，是二进制格式，并且对于ELF有以下<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format">讲解</a>，布局如下：<img src="https://bed1.oss-cn-beijing.aliyuncs.com/202112211115296.png"></p>
<p>可以在inc&#x2F;elf.h里查看ELF布局，左边是链接视图，是目标代码格式，比如我们编写，链接重定位过程中使用。右边是可执行视图，在这里加载到内存时使用，并且section header table不是必须。（简单区分section和segment使用时机即可，详细看《深入理解计算机系统》）因此我们的loader根据ELF读取很多段，在硬盘中读取单位为扇区，详细看关键文件注释，先给出部分的解释：</p>
<ul>
<li><p>.text 程序的执行命令集</p>
</li>
<li><p>.rodata 只读数据，比如ASCII，当然硬件并不会禁止写操作（？）</p>
</li>
<li><p>.data 已初始化的全局数据，比如全局定义x&#x3D;5</p>
</li>
<li><p>.bss 未初始化的全局数据，在link阶段会留空间给他，并且.bss在程序运行时候必须全为0</p>
</li>
</ul>
<p>编译时候将每个.c文件编译称.o文件，编码为硬件预期的二进制格式。在obj&#x2F;kern&#x2F;kernel里把所有的.o文件链接成二进制image（映像），转换为ELF格式，因此ELF英文解释为“可执行可链接的格式”。</p>
<p>对于本实验，你只需要考虑它作为header的功能（所需来自ELF header 和program headers table）：将后面的程序节加载入内存。boot loader不区分加载代码还是数据，直接加载然后执行就完事了。</p>
<p>我们可以输入以下指令进入内核program headers看所有节</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objdump -h obj/kern/kernel  </span><br><span class="line">//自己写的工具链就要多加i386-jos-elf-objdump</span><br></pre></td></tr></table></figure>

<p>你会看到很多节，远超上面列出来的。包括program header记录但是没有写进内存的。</p>
<p>重点来了：前面所说出问题的“链接地址”在此称作”VMA“，我们可以看作逻辑地址，由于还没分段，那么逻辑地址应该等于物理地址，也就是加载地址“LMA”。我们输入指令得到</p>
<p><img src="https://bed1.oss-cn-beijing.aliyuncs.com/202112211115572.png"></p>
<p>看.text节。</p>
<p>接着还有以下两种指令供你参考：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objdump -h obj/boot/boot.out //看boot被加载的section headers</span><br><span class="line">objdump -x obj/kern/kernel   //看内核所有headeres</span><br></pre></td></tr></table></figure>

<p>第二条命令执行后，可以看出Program Headers的字样，加载入内存的节会显示LOAD，和一些其他的信息，比如“paddr”代表物理地址，“vaddr”代表虚拟地址，“-sz”结尾代表大小</p>
<p>假设你已经理解了boot.S文件对于VMA的作用和某某关系（下面会讲），那么我们关注的VMA如何改？在boot&#x2F;Makefrag文件里，比如boot的VMA是0x7c00，那么对应文件里有-Ttext 0x7C00。</p>
<p>我将0x7c00改为0x2c00，会看到编译后的.asm从0x2c00开始boot，但是网上告诉我实际执行蹦过了这一段，头铁地接着从0x7c00开始运。运行一段时间后发现qemu-gdb报错<img src="https://bed1.oss-cn-beijing.aliyuncs.com/202112211116815.png"></p>
<p>很显然这里的GDT全0，导致了一些错误，那么我们的链接地址VMA对GDT的初始化出现了问题。</p>
<p>对于GDT初始化，查看代码可以发现有以下指令</p>
<p><img src="https://bed1.oss-cn-beijing.aliyuncs.com/202112211116196.png"></p>
<p>这里的lgdtw命令：将指定内存后的六个字节存放的GDTR寄存器里，发现存放的都是0，本应该是0x7c64，这里是第一个错误。</p>
<p>紧接着看：下面的ljmp会卡死，这条指令意思是以32位模式跳到下一条指令，本应该是0x7c32，但是同样出现了问题，后续的无法执行，即第二个错误。</p>
<h3 id="Exercise6"><a href="#Exercise6" class="headerlink" title="Exercise6"></a>Exercise6</h3><p>接着是内核的VMA，执行地址会指向高地址（VMA）但是实际上boot loader代码执行到低地址（LMA）。</p>
<p>看ELF header，里面的e_entry包含了就是我们的内核的（main.c里最后一句）VMA，可以通过以下指令查看entry的VMA</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -f obj/kern/kernel //查看file header</span><br></pre></td></tr></table></figure>

<p><img src="https://bed1.oss-cn-beijing.aliyuncs.com/202112211117403.png"></p>
<p>我们可以看到这里这两个地址的区别，原因就在于ELF得到的有GDT的线性地址，在没有页表下的解决方案：KERNBASE的删减。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#The kernel (this code) is linked at address ~(KERNBASE + 1 Meg), </span></span><br><span class="line"><span class="comment"># but the bootloader loads it at address ~1 Meg.</span></span><br></pre></td></tr></table></figure>

<p>假设你现在已经明白了main.c的过程，我们应该做一些事</p>
<ol>
<li><p>通过gdb 的x命令来查看内存，格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x/Nx ADDR //从指定地址以N个word（我这台机器里是4B 32位）查看内存</span><br></pre></td></tr></table></figure>

<p>更多命令请看<a target="_blank" rel="noopener" href="https://sourceware.org/gdb/current/onlinedocs/gdb/Memory.html">GDB手册</a></p>
</li>
<li><p>在进入boot时候来通过以下指令查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x/8x 0x00100000  //内核代码存放</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后再以相同方式看看kernel的进入时候的存放内容，告诉我为什么存放内容不同</p>
</li>
</ol>
<p>在两个阶段查看结果如下：</p>
<p><img src="https://bed1.oss-cn-beijing.aliyuncs.com/202112211117658.png"></p>
<p>如果你对boot干的事（1.保护模式2.load kernel sector）一清二楚的话，你就会知道，这个地址存放的八个字长内容不同是必然的。</p>
<h2 id="Part-3-The-Kernel"><a href="#Part-3-The-Kernel" class="headerlink" title="Part 3: The Kernel"></a>Part 3: The Kernel</h2><p>接下来的exercise中你将要写一些C代码了！</p>
<p><strong>使用虚拟内存来在独立空间里工作</strong></p>
<p>让我们看看LMA和VMA，在进入内核时候我们就发现了VMA和LMA的开始不同：ELF头显示了0x10001c的执行地址但是boot loader给出了0x10018的调用。</p>
<p>不过现在要完成完整的LMA转换：分段分页：内核页表结构的生成</p>
<p>在kern&#x2F;kernel.ld里，你就能看到VMA和LMA，一般内核喜欢让程序链接虚拟地址高地址，但是如何转化为内存物理地址呢？这种机制在lab2里会详细讲解。</p>
<p>对于本内核，VMA会给出0xf0100000，通过map分页得到物理地址0x00100000。现在先不说怎么做到，当然下个lab会教你如何在256MB限定下完成从虚拟地址0xf0000000 - 0xf0400000 映射物理地址0x00000000 - 0x00400000的分页map。</p>
<h3 id="Exercise7"><a href="#Exercise7" class="headerlink" title="Exercise7"></a>Exercise7</h3><ol>
<li>在内核kern&#x2F;kernel.asm代码movl %eax, %cr0处设置断点，看看内存0x00100000 和0xf0100000</li>
<li>单步执行，然后再看这两个内存，理解这其中的变化</li>
<li>如果分页机制的映射错了，那么第一行错的指令是什么，看看源代码文件，找出来</li>
</ol>
<p><strong>控制台的格式化输出</strong></p>
<p>C语言里有print（）格式化输出，同样I&#x2F;O也有，它叫cprintf，阅读</p>
<pre><code>kern/printf.c, lib/printfmt.c,  kern/console.c
</code></pre>
<p>这三个文件（看关键文件注释）来明白怎么这三个文件的关系。如果在后续的lab中你知道了为什么printfmt.c在lib目录下，这个关系就会变得很清楚。</p>
<h3 id="Exercise8"><a href="#Exercise8" class="headerlink" title="Exercise8"></a>Exercise8</h3><ol>
<li>在cprintf（）方法里我们省略了一小段代码：使用“%o”来打印八进制，</li>
</ol>
<p>回答以下问题：</p>
<ol>
<li><p>解释printf.c和console.c之间的接口，详细点：前者调用了什么功能，后者输出了什么功能</p>
</li>
<li><p>解释下列关于console 的代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (crt_pos &gt;= CRT_SIZE) &#123;</span><br><span class="line">            <span class="type">int</span> i;</span><br><span class="line">            memmove(crt_buf, crt_buf + CRT_COLS, (CRT_SIZE - CRT_COLS) * <span class="keyword">sizeof</span>(<span class="type">uint16_t</span>));</span><br><span class="line">            <span class="keyword">for</span> (i = CRT_SIZE - CRT_COLS; i &lt; CRT_SIZE; i++)</span><br><span class="line">                    crt_buf[i] = <span class="number">0x0700</span> | <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">            crt_pos -= CRT_COLS;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>单步执行以下代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> x = <span class="number">1</span>, y = <span class="number">3</span>, z = <span class="number">4</span>;</span><br><span class="line">cprintf(<span class="string">&quot;x %d, y %x, z %d\n&quot;</span>, x, y, z);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在cprintf（），fmt指向什么，ap指向什么</p>
</li>
<li><p>列出每个对于cons_putc, va_arg, 和vcprintf的调用</p>
</li>
<li><p>cons_putc:列出形参</p>
</li>
<li><p>va_arg:说出ap之前指向与调用之后的指向</p>
</li>
<li><p>vcprintf:列出两个实参</p>
</li>
</ul>
</li>
<li><p>运行以下代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0x00646c72</span>;</span><br><span class="line">    cprintf(<span class="string">&quot;H%x Wo%s&quot;</span>, <span class="number">57616</span>, &amp;i);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>输出是什么</p>
</li>
<li><p>单步执行解释输出的由来，有个<a target="_blank" rel="noopener" href="http://web.cs.mun.ca/~michael/c/ascii-table.html">ASCII表</a>供你参考</p>
</li>
<li><p>本次假设为小端，如果是大端你该怎么更改i的值？</p>
</li>
</ul>
</li>
<li><p>对于以下代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cprintf(<span class="string">&quot;x=%d y=%d&quot;</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>“y&#x3D;”之后应该输出什么（提示：不唯一）？为什么会这样？</p>
</li>
<li><p>假设GCC改变调用约定（栈增长变为低地址-&gt;高地址），在（参数）声明顺序下堆栈传参，你要怎么改cprintf（）或者它的接口，来成功传参数？</p>
</li>
<li><p>提高实验：通过ASCII来显示彩色字符</p>
</li>
</ol>
<h2 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h2><h3 id="Exercise9"><a href="#Exercise9" class="headerlink" title="Exercise9"></a>Exercise9</h3><ol>
<li><p>决定内核在哪初始化，并且确定栈的位置</p>
</li>
<li><p>内核代码如何为栈申请空间</p>
</li>
<li><p>栈空间的end是栈指针初始化esp的参考吗？</p>
</li>
</ol>
<p>我们知道栈是向下增长，具体为esp的逐步递减，在32位系统esp可以被4整除，这意味着esp的递减是4（比如0，4，8这样）。大量的指令比如call，通过使用这样的寄存器来访问地址</p>
<p>对于ebp寄存器，我们称之为“栈底”，很显然，指向高地址。比如在.c文件每个函数的调用时候，esp是通过指向ebp来完成函数栈的建立，随后esp递减。所以ebp用来定位多层函数时非常有用。因此相应的栈回溯功能是十分有必要的</p>
<h3 id="Exercise10"><a href="#Exercise10" class="headerlink" title="Exercise10"></a>Exercise10</h3><ol>
<li><p>为了了解函数调用，让我们追踪 <code>test_backtrace</code> 函数地址在 <code>obj/kern/kernel.asm</code>，设置断点，看看内核会做些什呢</p>
</li>
<li><p>每次递归嵌套多少个word通过函数传入栈？他们分别是什么</p>
</li>
<li><p>提示：你必须用本实验匹配的QEMU，不然你得自己翻译线性地址</p>
</li>
</ol>
<h3 id="Exercise11"><a href="#Exercise11" class="headerlink" title="Exercise11"></a>Exercise11</h3><p>monitor函数会在qemu的monitor（显示器）中让你看到一些日志，其中backtrace就能实现这个功能，当你输入：backtrace时候，就会打印日志</p>
<ol>
<li>实现上述指定的backtrace函数。</li>
</ol>
<p>对于这个exercise给你一些提示：你需要实现一个栈回溯功能，意味着你应该实现并调用mon_backtrace()，原型在kern&#x2F;monitor.c里。同时read_ebp() 在inc&#x2F;x86.h很有用。你应该让用户在交互时使用这个函数</p>
<p>这个栈回溯功能应该输出这个格式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Stack backtrace:</span><br><span class="line">  ebp f0109e58  eip f0100a62  args <span class="number">00000001</span> f0109e80 f0109e98 f0100ed2 <span class="number">00000031</span></span><br><span class="line">  ebp f0109ed8  eip f01000d6  args <span class="number">00000000</span> <span class="number">00000000</span> f0100058 f0109f28 <span class="number">00000061</span></span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>是不是很眼熟？对。gdb功能里 i r ebp eip也有类似的功能。</p>
<p>每行我们应该有ebp，eip，args。下面对格式进行一个简短的说明</p>
<ul>
<li><p>ebp为函数调用后的栈底</p>
</li>
<li><p>eip为函数返回后的ip，偷偷告诉你，就在ebp上面</p>
</li>
<li><p>args后的五个十六进制是五个参数，可以传参少于这个数，但是仍然列出5个</p>
</li>
</ul>
<p>然后我们对内容进行一个简短对说明</p>
<ul>
<li><p>第一行反应了现在执行函数，也就是mon_backtrace</p>
</li>
<li><p>第二行是调用mon_backtrace对函数</p>
</li>
<li><p>第三行往后即再上层调用，以此类推</p>
</li>
</ul>
<p>你应该打印合适的栈内容，从kern&#x2F;entry.S中，确定什么时候终止打印</p>
<p>接下来是关于接下来实验的理论提示。这是对K&amp;R第五章的一些内容</p>
<ul>
<li><p>Int *p&#x3D; (int *)100, 则（int）p+1&#x3D;101,(int) (p+1)&#x3D;104</p>
</li>
<li><p>p[i]&#x3D;*(p+i)</p>
</li>
<li><p>&amp;p[i]&#x3D;(p+i)</p>
</li>
<li><p>其实指针不难，你画图理解就行了</p>
</li>
</ul>
<p>每当操作系统对内存地址描述时，谨记：是值还是指针（地址址）。</p>
<h3 id="Exercise12"><a href="#Exercise12" class="headerlink" title="Exercise12"></a>Exercise12</h3><ol>
<li><p>monitor修改backtrace函数，增加显示：eip，函数名，源文件名，eip对应行数，在kernel&#x2F;kdebug.c修改debuginfo_eip</p>
</li>
<li><p>问题：在debuginfo_eip 中，_<em>STAB</em>*是哪里来的？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">给出以下线索</span><br><span class="line"><span class="number">1.</span>kern/kernel.ld找出_STAB_*</span><br><span class="line"><span class="number">2.</span>运行objdump -h/-G kern/kernel</span><br><span class="line"><span class="number">3.</span>gcc -pipe -nostdinc -O2 -fno-builtin -I. -MD -Wall -Wno-format -DJOS_KERNEL -gstabs -c -S kern/init.c,然后查看init.S</span><br><span class="line"><span class="number">4.</span>确定bootloader在加载内核ELF时候是否把符号表加载进来</span><br></pre></td></tr></table></figure>
</li>
<li><pre><code class="c">编写代码，让mon_backtrace能够调用debuginfo_eip，实现后者，输出格式如下：
K&gt; backtrace
Stack backtrace:
  ebp f010ff78  eip f01008ae  args 00000001 f010ff8c 00000000 f0110580 00000000
         kern/monitor.c:143: monitor+106
  ebp f010ffd8  eip f0100193  args 00000000 00001aac 00000660 00000000 00000000
         kern/init.c:49: i386_init+59
  ebp f010fff8  eip f010003d  args 00000000 00000000 0000ffff 10cf9a00 0000ffff
         kern/entry.S:70: &lt;unknown&gt;+0
K&gt; 
tips：printf(&quot;%.*s&quot;, length, string)可以让你输出指定长度的字符串，对文件名好用

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">## 回答问题汇总</span><br><span class="line"></span><br><span class="line">### Exercise3</span><br><span class="line"></span><br><span class="line">1.  .code32伪指令开始；ljmp语句切换，从16位地址模式切换到32位地址模式</span><br><span class="line"></span><br><span class="line">2.</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line">    7d81:	ff 15 18 00 01 00    	call   *0x10018</span><br><span class="line">    0x10000c:	movw   $0x1234,0x472</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>由GDB或者kernel&#x2F;entry.S可以得知为0x10000c</p>
</li>
<li><p>ELF存放了程序段数，段基址，段长</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ph每个结点为一个段</span></span><br><span class="line">ph = (<span class="keyword">struct</span> Proghdr *) ((<span class="type">uint8_t</span> *) ELFHDR + ELFHDR-&gt;e_phoff);</span><br><span class="line">	eph = ph + ELFHDR-&gt;e_phnum;</span><br><span class="line">	<span class="keyword">for</span> (; ph &lt; eph; ph++)</span><br><span class="line">		<span class="comment">// p_pa 是加载内核的程序段基址</span></span><br><span class="line">		readseg(ph-&gt;p_pa, ph-&gt;p_memsz, ph-&gt;p_offset);</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="Exercise4-1"><a href="#Exercise4-1" class="headerlink" title="Exercise4"></a>Exercise4</h3><p>1.学习笔记</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>单目运算符结合方向为从右向左。</span><br><span class="line">举例：</span><br><span class="line">*p++;  <span class="comment">// 将指针p的值加1，然后获取指针ip所指向的数据的值</span></span><br><span class="line">(*p)++;  <span class="comment">// 将指针p所指向的数据的值加1</span></span><br><span class="line"><span class="number">2.</span>对于a[i]，C编译器会立即将其转换为*(a+i)。同时对于i[a],计算结果相同。</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>数组名和指针的一个区别：指针是变量，可以进行赋值和加减运算；数组名不是变量，不能进行赋值和加减运算。</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>p[<span class="number">-1</span>],在语法上是合法的，只要保证元素存在，因此带来了安全隐患。</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>指向同一个数组（包括数组最后一个元素的下一个元素，可能考虑到兼容字符的<span class="string">&#x27;\0&#x27;</span>）的两个指针可以进行大小比较，而对没有指向同一个数组的两个指针进行大小比较的行为是undefined的。</span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>指针的合法操作：同类指针赋值、指针加减某个整数、指向同一数组的两个指针相减或比较大小（存放的值而不是说指向的值）、将指针赋值为<span class="number">0</span>或与<span class="number">0</span>比较；</span><br><span class="line">指针的非法操作：两个指针相加、相乘、相除，以及指针与浮点数相加减等。</span><br><span class="line"></span><br><span class="line"><span class="number">7.</span><span class="type">char</span> *p = <span class="string">&quot;now is the time&quot;</span>；是将一个指向字符数组的指针赋值给p，而不是字符串拷贝。C语言不提供任何对整个字符串作为一个单元进行处理的操作符。</span><br><span class="line"></span><br><span class="line">注意通过字符串指针修改字符串内容的行为是undefined的：</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> a[] = <span class="string">&quot;now is the time&quot;</span>;  <span class="comment">// an array</span></span><br><span class="line"><span class="type">char</span> *p = <span class="string">&quot;now is the time&quot;</span>;   <span class="comment">// a pointer</span></span><br></pre></td></tr></table></figure>

<ol>
<li>解读答案看关键文件注释</li>
</ol>
<h3 id="Exercise6-1"><a href="#Exercise6-1" class="headerlink" title="Exercise6"></a>Exercise6</h3><pre><code>刚进入boot时候BIOS上的地址没动过，此时从0x7c00开始boot会通过设置的保护模式将内核代码加载入内存，这时候高地址才会被修改，紧接着进入内核代码。
</code></pre>
<h3 id="Exercise7-1"><a href="#Exercise7-1" class="headerlink" title="Exercise7"></a>Exercise7</h3><p>1.<img src="https://bed1.oss-cn-beijing.aliyuncs.com/202112211117410.png"></p>
<p>2.单步执行后</p>
<p><img src="https://bed1.oss-cn-beijing.aliyuncs.com/202112211117952.png"></p>
<p>可以发现二者映射相同</p>
<p>问题：为什么？</p>
<p>A：对于GDB而言，代码地址，数据地址部分都是ELF里规定好的，当我们修改，查看地址内容时候也是有被页表转换查看，否则我一个程序查看比如数组内容，代码显示的内存地址就没用了。</p>
<p>所以无论是ELF存放的是系统的内核代码还是用户代码都一视同仁。但是我们一开始在低地址加载内核代码，也确实应该在低地址修改内存，而不是内核代码指定的高地址，并且没有开启页表没法转换。</p>
<p>之前做的kernbase消除这一问题，等于做了个“假页表”，而题目给出的汇编代码即开启页表，开启之后的映射就会按照页表的页表项进行映射，因此我们就会发现gdb查看的地址内容符合内核代码给的地址操作。</p>
<p>3.关键代码即题目所给代码，如果注释掉，假页表映射有限，会出现访问越界问题</p>
<h3 id="Exercise8-1"><a href="#Exercise8-1" class="headerlink" title="Exercise8"></a>Exercise8</h3><ol>
<li><pre><code class="c">//给出八进制代码
num = getuint(&amp;ap, lflag);
            //设置基数为8
            base = 8;
            goto number;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   其余解释查看关键文件注释</span><br><span class="line"></span><br><span class="line">2. console.c</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line">if (crt_pos &gt;= CRT_SIZE) &#123;</span><br><span class="line">        int i;</span><br><span class="line">        memcpy(crt_buf, crt_buf + CRT_COLS, (CRT_SIZE - CRT_COLS) * sizeof(uint16_t));</span><br><span class="line">        for (i = CRT_SIZE - CRT_COLS; i &lt; CRT_SIZE; i++)</span><br><span class="line">                crt_buf[i] = 0x0700 | &#x27; &#x27;;</span><br><span class="line">        crt_pos -= CRT_COLS;</span><br><span class="line"> &#125;</span><br><span class="line">* 变量</span><br><span class="line">crt_pos      CRT_SIZE    CRT_COLS          crt_buf</span><br><span class="line">尾字符位置    页char大小    字符列数         字符buf</span><br><span class="line"></span><br><span class="line">* 函数</span><br><span class="line">memcpy 内存复制</span><br><span class="line"></span><br><span class="line">* 过程</span><br><span class="line">如果发现尾字符位置超过一页位置，就应该讲这一页向上一行进行复制，然后清空这腾出来的一行，然后修改尾字符位置向上一行</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><pre><code class="c">int x = 1, y = 3, z = 4;
cprintf(&quot;x %d, y %x, z %d\n&quot;, x, y, z);

* 调用cprintf，fmt什么内容，ap什么内容
&quot;x %d, y %x, z %d\n&quot;，ap为va_list，即所有参数列表，包括了xyz

* 按照执行的顺序列出所有对cons_putc, va_arg，和vcprintf的调用
看注释

* 列出每个对于cons_putc, va_arg, 和vcprintf的调用
看注释

* cons_putc:列出形参
int c

* va_arg:说出ap之前指向与调用之后的指向
ap:1,3,4=&gt;3,4

* vcprintf:列出两个实参
&quot;x %d, y %x, z %d\n&quot;  1,3,4
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">4. ```c</span><br><span class="line">       unsigned int i = 0x00646c72;</span><br><span class="line">           cprintf(&quot;H%x Wo%s&quot;, 57616, &amp;i);</span><br><span class="line">   </span><br><span class="line">   *   输出是什么</span><br><span class="line">   He110 World</span><br><span class="line">   </span><br><span class="line">   *   单步执行解释输出的由来，有个[ASCII表](http://web.cs.mun.ca/\~michael/c/ascii-table.html)供你参考</span><br><span class="line">   1.第一个参数的值是57616，它对应的16进制的表示形式为e110，所以前面就变成的He110。</span><br><span class="line">   2.输出参数所指向的字符串,变量i代表字符串。但是i定义为int，所以我们按字节分析出char</span><br><span class="line">   3.x86是小端模式，高字节放在高地址。所以存放顺序0x72(&#x27;r&#x27;)，0x6c(&#x27;l&#x27;)，0x64(&#x27;d&#x27;)，0x00(&#x27;\0&#x27;).</span><br><span class="line">   5.所以在cprintf将会从i的地址开始一个字节一个字节遍历，正好输出 &quot;World&quot;</span><br><span class="line">   </span><br><span class="line">   *   本次假设为小端，如果是大端你该怎么更改i的值？</span><br><span class="line">   i = 0x726c6400</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>对于以下代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cprintf(<span class="string">&quot;x=%d y=%d&quot;</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">* “y=”之后应该输出什么（提示：不唯一）？为什么会这样？</span><br><span class="line">getint调用va_arg时候，取，更改参数因为没有指定y，所以参数下标越界</span><br></pre></td></tr></table></figure>
</li>
<li><p>&#96;&#96;&#96;c<br>假设GCC改变调用约定（栈增长变为低地址-&gt;高地址），在（参数）声明顺序下堆栈传参，你要怎么改cprintf（）或者它的接口，来成功传参数？<br>形参反序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### Exercise9</span><br><span class="line"></span><br><span class="line">给出obj/kern/kernel.asm中有关代码</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line">1.内核为栈的开辟做准备：第一次没有esp，ebp，所以额外准备</span><br><span class="line">f010002f:	bd 00 00 00 00       	mov    $0x0,%ebp</span><br><span class="line"></span><br><span class="line">	# Set the stack pointer</span><br><span class="line">	movl	$(bootstacktop),%esp</span><br><span class="line">f0100034:	bc 00 00 11 f0       	mov    $0xf0110000,%esp</span><br><span class="line"></span><br><span class="line">	# 之前内核的entry作初始化，为栈开辟作准备，然后我们正式开始C代码，为接下来内核的main做准备：先开辟main栈</span><br><span class="line">	call	i386_init</span><br><span class="line">f0100039:	e8 6c 00 00 00       	call   f01000aa &lt;i386_init&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.内核申请第一个栈：</span><br><span class="line">void</span><br><span class="line">i386_init(void)</span><br><span class="line">&#123;</span><br><span class="line">f01000aa:	f3 0f 1e fb          	endbr32 </span><br><span class="line">f01000ae:	55                   	push   %ebp</span><br><span class="line">f01000af:	89 e5                	mov    %esp,%ebp</span><br><span class="line">f01000b1:	53                   	push   %ebx</span><br><span class="line">f01000b2:	83 ec 08             	sub    $0x8,%esp</span><br><span class="line">//紧接着为新的ELF加载做准备：.bss,static之类，之前只是确定位置，并没有清零</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="Exercise10-1"><a href="#Exercise10-1" class="headerlink" title="Exercise10"></a>Exercise10</h3><p>给出test_backtrace及其有关反汇编代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test_backtrace</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">test_backtrace</span><span class="params">(<span class="type">int</span> x)</span></span><br><span class="line">&#123;</span><br><span class="line">f0100040:	f3 <span class="number">0f</span> <span class="number">1</span>e fb          	endbr32 </span><br><span class="line">f0100044:	<span class="number">55</span>                   	push   %ebp</span><br><span class="line">f0100045:	<span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line">f0100047:	<span class="number">56</span>                   	push   %esi<span class="comment">//第一个参数4B</span></span><br><span class="line">f0100048:	<span class="number">53</span>                   	push   %ebx<span class="comment">//第二个参数4B</span></span><br><span class="line">f0100049:	e8 <span class="number">7</span>e <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>       	call   f01001cc &lt;__x86.get_pc_thunk.bx&gt;</span><br><span class="line">f010004e:	<span class="number">81</span> c3 ba <span class="number">12</span> <span class="number">01</span> <span class="number">00</span>    	add    $<span class="number">0x112ba</span>,%ebx</span><br><span class="line">f0100054:	<span class="number">8b</span> <span class="number">75</span> <span class="number">08</span>             	mov    <span class="number">0x8</span>(%ebp),%esi<span class="comment">//看下面的eax</span></span><br><span class="line">	cprintf(<span class="string">&quot;entering test_backtrace %d\n&quot;</span>, x);</span><br><span class="line">f0100057:	<span class="number">83</span> ec <span class="number">08</span>             	sub    $<span class="number">0x8</span>,%esp</span><br><span class="line">f010005a:	<span class="number">56</span>                   	push   %esi</span><br><span class="line">f010005b:	<span class="number">8</span>d <span class="number">83</span> d8 <span class="number">07</span> ff ff    	lea    <span class="number">-0xf828</span>(%ebx),%eax</span><br><span class="line">f0100061:	<span class="number">50</span>                   	push   %eax</span><br><span class="line">f0100062:	e8 <span class="number">26</span> <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span>       	call   f0100a8d &lt;cprintf&gt;</span><br><span class="line">	<span class="keyword">if</span> (x &gt; <span class="number">0</span>)</span><br><span class="line">f0100067:	<span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line">f010006a:	<span class="number">85</span> f6                	test   %esi,%esi</span><br><span class="line">f010006c:	<span class="number">7</span>e <span class="number">29</span>                	jle    f0100097 &lt;test_backtrace+<span class="number">0x57</span>&gt;<span class="comment">//x==0</span></span><br><span class="line">		test_backtrace(x<span class="number">-1</span>);</span><br><span class="line">f010006e:	<span class="number">83</span> ec <span class="number">0</span>c             	sub    $<span class="number">0xc</span>,%esp</span><br><span class="line">f0100071:	<span class="number">8</span>d <span class="number">46</span> ff             	lea    <span class="number">-0x1</span>(%esi),%eax<span class="comment">//x-1</span></span><br><span class="line">f0100074:	<span class="number">50</span>                   	push   %eax<span class="comment">//callee会将eax作为返回值使用，caller为callee传入x-1保存在这里</span></span><br><span class="line">f0100075:	e8 c6 ff ff ff       	call   f0100040 &lt;test_backtrace&gt;<span class="comment">//递归调用</span></span><br><span class="line">f010007a:	<span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="title function_">mon_backtrace</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span>;</span><br><span class="line">	cprintf(<span class="string">&quot;leaving test_backtrace %d\n&quot;</span>, x);</span><br><span class="line">f010007d:	<span class="number">83</span> ec <span class="number">08</span>             	sub    $<span class="number">0x8</span>,%esp</span><br><span class="line">f0100080:	<span class="number">56</span>                   	push   %esi</span><br><span class="line">f0100081:	<span class="number">8</span>d <span class="number">83</span> f4 <span class="number">07</span> ff ff    	lea    <span class="number">-0xf80c</span>(%ebx),%eax</span><br><span class="line">f0100087:	<span class="number">50</span>                   	push   %eax</span><br><span class="line">f0100088:	e8 <span class="number">00</span> <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span>       	call   f0100a8d &lt;cprintf&gt;</span><br><span class="line">&#125;</span><br><span class="line">f010008d:	<span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line">f0100090:	<span class="number">8</span>d <span class="number">65</span> f8             	lea    <span class="number">-0x8</span>(%ebp),%esp</span><br><span class="line">f0100093:	<span class="number">5b</span>                   	pop    %ebx</span><br><span class="line">f0100094:	<span class="number">5</span>e                   	pop    %esi</span><br><span class="line">f0100095:	<span class="number">5</span>d                   	pop    %ebp</span><br><span class="line">f0100096:	c3                   	ret    </span><br><span class="line"></span><br><span class="line"><span class="comment">//		mon_backtrace(0, 0, 0);</span></span><br><span class="line">f0100097:	<span class="number">83</span> ec <span class="number">04</span>             	sub    $<span class="number">0x4</span>,%esp</span><br><span class="line">f010009a:	<span class="number">6</span>a <span class="number">00</span>                	push   $<span class="number">0x0</span></span><br><span class="line">f010009c:	<span class="number">6</span>a <span class="number">00</span>                	push   $<span class="number">0x0</span></span><br><span class="line">f010009e:	<span class="number">6</span>a <span class="number">00</span>                	push   $<span class="number">0x0</span></span><br><span class="line">f01000a0:	e8 <span class="number">0</span>c <span class="number">08</span> <span class="number">00</span> <span class="number">00</span>       	call   f01008b1 &lt;mon_backtrace&gt;</span><br><span class="line">f01000a5:	<span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line">f01000a8:	eb d3                	jmp    f010007d &lt;test_backtrace+<span class="number">0x3d</span>&gt;<span class="comment">//返回test_backtrace</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//调用test_backtrace</span></span><br><span class="line">	<span class="comment">// Test the stack backtrace function (lab 1 only)</span></span><br><span class="line">	test_backtrace(<span class="number">5</span>);</span><br><span class="line">f01000f0:	c7 <span class="number">04</span> <span class="number">24</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	movl   $<span class="number">0x5</span>,(%esp)</span><br><span class="line">f01000f7:	e8 <span class="number">44</span> ff ff ff       	call   f0100040 &lt;test_backtrace&gt;</span><br></pre></td></tr></table></figure>



<h3 id="Exercise11-1"><a href="#Exercise11-1" class="headerlink" title="Exercise11"></a>Exercise11</h3><p>给出mon_backtrace的补全代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">mon_backtrace</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="keyword">struct</span> Trapframe *tf)</span><span class="comment">//参数个数，参数列表，还有一个不知道啥，不影响</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> *ebp = (<span class="type">int</span> *)read_ebp();<span class="comment">//read得到ebp寄存器的值，然后转为指针：就像寄存器那样干</span></span><br><span class="line">	</span><br><span class="line">	cprintf(<span class="string">&quot;Stack backtrace:\n&quot;</span>);</span><br><span class="line">	<span class="keyword">while</span>((<span class="type">int</span>)ebp != <span class="number">0x0</span>) &#123;<span class="comment">//end of print：main栈前</span></span><br><span class="line">		cprintf(<span class="string">&quot;  ebp %08x&quot;</span>, *ebp);</span><br><span class="line">		cprintf(<span class="string">&quot;  eip %08x&quot;</span>, *(ebp+<span class="number">1</span>));</span><br><span class="line">		cprintf(<span class="string">&quot;  args&quot;</span>);</span><br><span class="line">		cprintf(<span class="string">&quot; %08x&quot;</span>, *(ebp+<span class="number">2</span>));</span><br><span class="line">		cprintf(<span class="string">&quot; %08x&quot;</span>, *(ebp+<span class="number">3</span>));</span><br><span class="line">		cprintf(<span class="string">&quot; %08x&quot;</span>, *(ebp+<span class="number">4</span>));</span><br><span class="line">		cprintf(<span class="string">&quot; %08x&quot;</span>, *(ebp+<span class="number">5</span>));</span><br><span class="line">		cprintf(<span class="string">&quot; %08x\n&quot;</span>, *(ebp+<span class="number">6</span>));<span class="comment">//5个参数</span></span><br><span class="line">		ebp = (<span class="type">int</span> *)(*ebp);<span class="comment">//别忘了类型转换</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Exercise12-1"><a href="#Exercise12-1" class="headerlink" title="Exercise12"></a>Exercise12</h3><p>给出以下代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//更详细代码看注释</span></span><br><span class="line"><span class="comment">//backtrace</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">mon_backtrace</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> *ebp = (<span class="type">int</span> *)read_ebp();<span class="comment">//like %ebp</span></span><br><span class="line">	cprintf(<span class="string">&quot;Stack backtrace:\n&quot;</span>);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Eipdebuginfo</span> <span class="title">info</span>;</span><span class="comment">//文件string信息，定义在kdebug.h</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (ebp != <span class="number">0x0</span>) &#123;</span><br><span class="line">		<span class="comment">// 第一行的当前ebp和栈环境是mon_backtrace的</span></span><br><span class="line">		cprintf(<span class="string">&quot;ebp %8x eip %8x args %08x %08x %08x %08x %08x &quot;</span>, </span><br><span class="line">				ebp, ebp[<span class="number">1</span>], ebp[<span class="number">2</span>], ebp[<span class="number">3</span>], ebp[<span class="number">4</span>], ebp[<span class="number">5</span>], ebp[<span class="number">6</span>]);</span><br><span class="line">		debuginfo_eip(ebp[<span class="number">1</span>], &amp;info);</span><br><span class="line">		cprintf(<span class="string">&quot;%s:%d: %.*s+%d\n&quot;</span>, info.eip_file, info.eip_line, info.eip_fn_namelen, </span><br><span class="line">				info.eip_fn_name, ebp[<span class="number">1</span>]-info.eip_fn_addr);</span><br><span class="line">		ebp = (<span class="type">int</span> *)ebp[<span class="number">0</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//Eipdebuginfo</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Eipdebuginfo</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *eip_file;		<span class="comment">// Eip所在文件名</span></span><br><span class="line">	<span class="type">int</span> eip_line;			<span class="comment">// eip所在文件源代码行数</span></span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *eip_fn_name;	<span class="comment">// eip所在函数名</span></span><br><span class="line">					<span class="comment">//  - Note: not null terminated!</span></span><br><span class="line">	<span class="type">int</span> eip_fn_namelen;		<span class="comment">// 函数长度</span></span><br><span class="line">	<span class="type">uintptr_t</span> eip_fn_addr;		<span class="comment">// 函数开始地址</span></span><br><span class="line">	<span class="type">int</span> eip_fn_narg;		<span class="comment">// 函数的参数个数</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//stab</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Stab</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span> n_strx;	<span class="comment">// index into string table of name</span></span><br><span class="line">	<span class="type">uint8_t</span> n_type;         <span class="comment">// 类型,比如fun，so</span></span><br><span class="line">	<span class="type">uint8_t</span> n_other;        <span class="comment">// misc info (usually empty)</span></span><br><span class="line">	<span class="type">uint16_t</span> n_desc;        <span class="comment">// 给定类型下的描述域,题目下是代码长度</span></span><br><span class="line">	<span class="type">uintptr_t</span> n_value;	<span class="comment">// 符号值，本题当作地址</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//debuginfo_eip增加内容 </span></span><br><span class="line">stab_binsearch(stabs, &amp;lline, &amp;rline, N_SLINE, addr);<span class="comment">//二分搜索得到代码行数</span></span><br><span class="line"><span class="keyword">if</span> (lline &lt;= rline) &#123;</span><br><span class="line">    info-&gt;eip_line = stabs[lline].n_desc;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>给定符号表stab的例子更直观查看<img src="https://bed1.oss-cn-beijing.aliyuncs.com/202112211435651.png"></p>
<p>happy！代码在这里：<a target="_blank" rel="noopener" href="https://github.com/sakura-mac/mit_6.828_jos">Source Code</a></p>
<p><img src="https://bed1.oss-cn-beijing.aliyuncs.com/202112211118460.png"></p>
<h2 id="关键文件注释"><a href="#关键文件注释" class="headerlink" title="关键文件注释"></a>关键文件注释</h2><h3 id="boot-x2F-boot-S"><a href="#boot-x2F-boot-S" class="headerlink" title="boot&#x2F;boot.S"></a>boot&#x2F;boot.S</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;inc/mmu.h&gt;</span><br><span class="line"></span><br><span class="line"># 转换为32位保护模式，然后跳转到main.c执行</span><br><span class="line"># BIOS从硬盘第一个扇区加载这个代码到内存0x7c00处</span><br><span class="line"># 然后以%cs=0 %ip=7c00开始执行保 护模式</span><br><span class="line"></span><br><span class="line">.set PROT_MODE_CSEG, 0x8         # 内核代码段选择子</span><br><span class="line">.set PROT_MODE_DSEG, 0x10        # 内核数据段选择子</span><br><span class="line">.set CR0_PE_ON,      0x1         # 保护模式开关</span><br><span class="line"></span><br><span class="line">.globl start</span><br><span class="line">start:</span><br><span class="line">  .code16                     # 汇编为16位模式</span><br><span class="line">  cli                         # 关中断</span><br><span class="line">  cld                         # 字符串增量操作（清eflags里DF，进行一个顺序处理）</span><br><span class="line"></span><br><span class="line">  # Set up the important data segment registers (DS, ES, SS).</span><br><span class="line">  xorw    %ax,%ax             # 第0段</span><br><span class="line">  movw    %ax,%ds             # -&gt; 代码段</span><br><span class="line">  movw    %ax,%es             # -&gt; 附加段</span><br><span class="line">  movw    %ax,%ss             # -&gt; 栈段</span><br><span class="line"></span><br><span class="line">  # 打开A20:</span><br><span class="line">  #   对于早期PC, 物理地址只有20位地址线，超过则会进位为0，而后来为了兼容即在16位到	 #	 32位转换时打开第21位地址线，从而为GDT做准备</span><br><span class="line">seta20.1:</span><br><span class="line">  inb     $0x64,%al               # 等待不忙</span><br><span class="line">  testb   $0x2,%al</span><br><span class="line">  jnz     seta20.1</span><br><span class="line"></span><br><span class="line">  movb    $0xd1,%al               # 0xd1 -&gt; 端口 0x64</span><br><span class="line">  outb    %al,$0x64</span><br><span class="line"></span><br><span class="line">seta20.2:</span><br><span class="line">  inb     $0x64,%al               # 等待不忙</span><br><span class="line">  testb   $0x2,%al</span><br><span class="line">  jnz     seta20.2</span><br><span class="line"></span><br><span class="line">  movb    $0xdf,%al               # 0xdf -&gt; 端口 0x60</span><br><span class="line">  outb    %al,$0x60</span><br><span class="line"></span><br><span class="line">  # 转换实模式到保护模式, 通过使用GDT和段转换确保虚拟地址和物理地址一一对应</span><br><span class="line">  # 因此有效mermory map在这个过程中不改变</span><br><span class="line">  lgdt    gdtdesc</span><br><span class="line">  movl    %cr0, %eax</span><br><span class="line">  orl     $CR0_PE_ON, %eax</span><br><span class="line">  movl    %eax, %cr0</span><br><span class="line">  </span><br><span class="line">  # 以32位模式，跳转到下一个指令</span><br><span class="line">  # 即进入32位模式</span><br><span class="line">  ljmp    $PROT_MODE_CSEG, $protcseg</span><br><span class="line"></span><br><span class="line">  .code32                     # 汇编伪指令32位模式</span><br><span class="line">protcseg:</span><br><span class="line">  # 设置保护模式到数据寄存器</span><br><span class="line">  movw    $PROT_MODE_DSEG, %ax    # 段选择子</span><br><span class="line">  movw    %ax, %ds                # -&gt; DS: 数据段</span><br><span class="line">  movw    %ax, %es                # -&gt; ES: 附加段</span><br><span class="line">  movw    %ax, %fs                # -&gt; FS</span><br><span class="line">  movw    %ax, %gs                # -&gt; GS</span><br><span class="line">  movw    %ax, %ss                # -&gt; SS: 栈段</span><br><span class="line">  </span><br><span class="line">  # 把栈顶指针esp指向main.c文件中去</span><br><span class="line">  movl    $start, %esp</span><br><span class="line">  call bootmain</span><br><span class="line"></span><br><span class="line">  # 当然如果引导gdt返回（失败），那么就死循环</span><br><span class="line">spin:</span><br><span class="line">  jmp spin</span><br><span class="line"></span><br><span class="line"># 引导GDT，也可以认为初始化</span><br><span class="line">.p2align 2                                # 4字节对齐</span><br><span class="line">gdt:</span><br><span class="line">  SEG_NULL				# 空段</span><br><span class="line">  SEG(STA_X|STA_R, 0x0, 0xffffffff)	# 代码段</span><br><span class="line">  SEG(STA_W, 0x0, 0xffffffff)	        # 数据段</span><br><span class="line"></span><br><span class="line">gdtdesc:</span><br><span class="line">  .word   0x17                            # gdt长度-1</span><br><span class="line">  .long   gdt                             # gdt的地址</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="boot-x2F-main-c"><a href="#boot-x2F-main-c" class="headerlink" title="boot&#x2F;main.c"></a>boot&#x2F;main.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/x86.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/elf.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**********************************************************************</span></span><br><span class="line"><span class="comment"> *简易的的boot loader，功能为从第一个IDE硬盘读取ELF格式的内核 </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *硬盘格式</span></span><br><span class="line"><span class="comment"> *  * boot.S和main.c是boot loader的全部代码，存放第一个扇区</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  * 第二个扇区开始存放内核</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  * 内核img必须是ELF格式</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * boot 步骤</span></span><br><span class="line"><span class="comment"> *  * 当cpu再BIOS中加载硬盘到内存中时</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  * BIOS初始化设备,中断描述符表, 读取第一个扇区到内存然后jmp到0x7c00</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  * 然后boot loader执行</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  * 从boot.S开始执行，它将会设置保护模式，然后main.c接管</span></span><br><span class="line"><span class="comment"> *    </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *  * bootmain()就是本文件，它接管后到任务就是读取内核，跳转内核</span></span><br><span class="line"><span class="comment"> **********************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECTSIZE	512 <span class="comment">//扇区字节大小</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELFHDR		((struct Elf *) 0x10000) <span class="comment">// 判定抓取内核空间</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">readsect</span><span class="params">(<span class="type">void</span>*, <span class="type">uint32_t</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">readseg</span><span class="params">(<span class="type">uint32_t</span>, <span class="type">uint32_t</span>, <span class="type">uint32_t</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">bootmain</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Proghdr</span> *<span class="title">ph</span>, *<span class="title">eph</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 从硬盘中读取一页</span></span><br><span class="line">	readseg((<span class="type">uint32_t</span>) ELFHDR, SECTSIZE*<span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 判定是否ELF格式</span></span><br><span class="line">	<span class="keyword">if</span> (ELFHDR-&gt;e_magic != ELF_MAGIC)</span><br><span class="line">		<span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 加载每个内核段 (忽略 ph flags)，接下来两行都是源自ELF header</span></span><br><span class="line"><span class="comment">/*ELF program header</span></span><br><span class="line"><span class="comment"> *int type; // loadable code or data, dynamic linking info, etc. </span></span><br><span class="line"><span class="comment"> *int offset; // ELF里段偏移</span></span><br><span class="line"><span class="comment"> *int virtaddr; // virtual address to map segment </span></span><br><span class="line"><span class="comment"> *int physaddr; // physical address, not used 还没分页所以没用</span></span><br><span class="line"><span class="comment"> *int filesize; // size of segment in file </span></span><br><span class="line"><span class="comment"> *int memsize; // size of segment in memory (bigger if contains BSS) </span></span><br><span class="line"><span class="comment"> *int flags; // Read, Write, Execute bits</span></span><br><span class="line"><span class="comment"> *int align; // required alignment, invariably hardware page size</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">	ph = (<span class="keyword">struct</span> Proghdr *) ((<span class="type">uint8_t</span> *) ELFHDR + ELFHDR-&gt;e_phoff);</span><br><span class="line">	eph = ph + ELFHDR-&gt;e_phnum;</span><br><span class="line">	<span class="keyword">for</span> (; ph &lt; eph; ph++)</span><br><span class="line">		<span class="comment">// p_pa 是加载内核的程序段偏移，接下来一行源自program header</span></span><br><span class="line">    <span class="comment">//加载每个程序段（忽略ph标志）</span></span><br><span class="line">		readseg(ph-&gt;p_pa, ph-&gt;p_memsz, ph-&gt;p_offset);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 从ELF头得到信息进入内核执行entry,源自ELF header</span></span><br><span class="line">	<span class="comment">// notes：不返回！，汇编指令call   *0x10018</span></span><br><span class="line">	((<span class="type">void</span> (*)(<span class="type">void</span>)) (ELFHDR-&gt;e_entry))();</span><br><span class="line"></span><br><span class="line">bad:</span><br><span class="line">	outw(<span class="number">0x8A00</span>, <span class="number">0x8A00</span>);</span><br><span class="line">	outw(<span class="number">0x8A00</span>, <span class="number">0x8E00</span>);</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">		<span class="comment">/* 什么都不干 */</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从‘offset’在内核中读取‘count’字节数，返回到地址‘pa’</span></span><br><span class="line"><span class="comment">// 可能复制量超过要求！</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">readseg</span><span class="params">(<span class="type">uint32_t</span> pa, <span class="type">uint32_t</span> count, <span class="type">uint32_t</span> offset)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> end_pa;</span><br><span class="line"></span><br><span class="line">	end_pa = pa + count;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 向下取到扇区边界</span></span><br><span class="line">	pa &amp;= ~(SECTSIZE - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 把字节转换为扇区，然后内核从扇区1开始执行</span></span><br><span class="line">	offset = (offset / SECTSIZE) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果太慢，可以一次读很多扇区</span></span><br><span class="line">	<span class="comment">// 我们可以写内存超过要求，但是没关系 --</span></span><br><span class="line">	<span class="comment">// 因为可以递增加载</span></span><br><span class="line">	<span class="keyword">while</span> (pa &lt; end_pa) &#123;</span><br><span class="line">		<span class="comment">// 因为还没开启分页，并且使用了指定段表 (see boot.S),所以可以直接访问物理地 			//址.  当然JOS如果使用了MMU就不行了</span></span><br><span class="line">		readsect((<span class="type">uint8_t</span>*) pa, offset);</span><br><span class="line">		pa += SECTSIZE;</span><br><span class="line">		offset++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">waitdisk</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 等待硬盘就绪</span></span><br><span class="line">	<span class="keyword">while</span> ((inb(<span class="number">0x1F7</span>) &amp; <span class="number">0xC0</span>) != <span class="number">0x40</span>)</span><br><span class="line">		<span class="comment">/* do nothing */</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">readsect</span><span class="params">(<span class="type">void</span> *dst, <span class="type">uint32_t</span> offset)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 等待硬盘就绪</span></span><br><span class="line">	waitdisk();</span><br><span class="line"></span><br><span class="line">	outb(<span class="number">0x1F2</span>, <span class="number">1</span>);		<span class="comment">// count = 1</span></span><br><span class="line">	outb(<span class="number">0x1F3</span>, offset);</span><br><span class="line">	outb(<span class="number">0x1F4</span>, offset &gt;&gt; <span class="number">8</span>);</span><br><span class="line">	outb(<span class="number">0x1F5</span>, offset &gt;&gt; <span class="number">16</span>);</span><br><span class="line">	outb(<span class="number">0x1F6</span>, (offset &gt;&gt; <span class="number">24</span>) | <span class="number">0xE0</span>);</span><br><span class="line">	outb(<span class="number">0x1F7</span>, <span class="number">0x20</span>);	<span class="comment">// 硬件读取命令cmd 0x20 - 来读取扇区</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 等待硬盘就绪</span></span><br><span class="line">	waitdisk();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 读一个扇区</span></span><br><span class="line">	insl(<span class="number">0x1F0</span>, dst, SECTSIZE/<span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pointers-c"><a href="#Pointers-c" class="headerlink" title="Pointers.c"></a>Pointers.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">f</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a[<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> *b = <span class="built_in">malloc</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="type">int</span> *c;</span><br><span class="line">    <span class="type">int</span> i;<span class="comment">//a,b,c,i相邻存放，存放顺序取决于本身计算机大端还是小端,假设小端存放</span></span><br><span class="line"><span class="comment">//第一行 1: a = %p, b = %p, c = %p 输出各自的值，由于没有定义所以不确定</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;1: a = %p, b = %p, c = %p\n&quot;</span>, a, b, c);</span><br><span class="line"></span><br><span class="line">    c = a;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">	a[i] = <span class="number">100</span> + i;	<span class="comment">//a[0...3]= 100, 101, 102, 103</span></span><br><span class="line">    c[<span class="number">0</span>] = <span class="number">200</span>;	<span class="comment">//a[0]=200</span></span><br><span class="line"><span class="comment">//第二行 2: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;2: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n&quot;</span>,</span><br><span class="line">	   a[<span class="number">0</span>], a[<span class="number">1</span>], a[<span class="number">2</span>], a[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    c[<span class="number">1</span>] = <span class="number">300</span>;	<span class="comment">// a[1]=300</span></span><br><span class="line">    *(c + <span class="number">2</span>) = <span class="number">301</span>;	<span class="comment">// a[2]=301</span></span><br><span class="line">    <span class="number">3</span>[c] = <span class="number">302</span>;	<span class="comment">// *（3+c）即a[3]=302</span></span><br><span class="line"><span class="comment">//第三行 3: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;3: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n&quot;</span>,</span><br><span class="line">	   a[<span class="number">0</span>], a[<span class="number">1</span>], a[<span class="number">2</span>], a[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    c = c + <span class="number">1</span>;</span><br><span class="line">    *c = <span class="number">400</span>;<span class="comment">//a[1]=400</span></span><br><span class="line"><span class="comment">//第四行 4: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;4: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n&quot;</span>,</span><br><span class="line">	   a[<span class="number">0</span>], a[<span class="number">1</span>], a[<span class="number">2</span>], a[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    c = (<span class="type">int</span> *) ((<span class="type">char</span> *) c + <span class="number">1</span>); </span><br><span class="line">    *c = <span class="number">500</span>;<span class="comment">//301=16*(2+16)+13</span></span><br><span class="line">    <span class="comment">//a[1]=0x190,a[2]=0x12d,500=0x1f4小端存放: 90 f4 01 00 00 01 00 00 </span></span><br><span class="line">    <span class="comment">//a[1]=0x1f490=0+144+1024+61140+65536=127844</span></span><br><span class="line">    <span class="comment">//：90 f4 01 00 00 01 00 00-&gt;a[1]=127844,a[2]=256</span></span><br><span class="line"><span class="comment">//第五行 5: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;5: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n&quot;</span>,</span><br><span class="line">	   a[<span class="number">0</span>], a[<span class="number">1</span>], a[<span class="number">2</span>], a[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    b = (<span class="type">int</span> *) a + <span class="number">1</span>;<span class="comment">//b指向a[1]</span></span><br><span class="line">    c = (<span class="type">int</span> *) ((<span class="type">char</span> *) a + <span class="number">1</span>);<span class="comment">//同上，从a[0]第二个字节开始修改，影响a[0]与a[1]</span></span><br><span class="line"><span class="comment">//第六行 6: a = %p, b = %p, c = %p</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;6: a = %p, b = %p, c = %p\n&quot;</span>, a, b, c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">main</span><span class="params">(<span class="type">int</span> ac, <span class="type">char</span> **av)</span></span><br><span class="line">&#123;</span><br><span class="line">    f();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="kern-x2F-printf-c"><a href="#kern-x2F-printf-c" class="headerlink" title="kern&#x2F;printf.c"></a>kern&#x2F;printf.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//基于printfmt格式化和cputchar内核控制台输出，来完成内核输出到控制台的功能</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/stdarg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">putch</span><span class="params">(<span class="type">int</span> ch, <span class="type">int</span> *cnt)</span><span class="comment">//3.调用cputchar</span></span><br><span class="line">&#123;</span><br><span class="line">	cputchar(ch);<span class="comment">//内核态向控制台输出</span></span><br><span class="line">	*cnt++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">vcprintf</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *fmt, va_list ap)</span><span class="comment">//2.调用vprintfmt，输入putch返回值作参数</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	vprintfmt((<span class="type">void</span>*)putch, &amp;cnt, fmt, ap);<span class="comment">//四个参数：1.函数指针2.计数3.格式4.参数列表</span></span><br><span class="line">	<span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">cprintf</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *fmt, ...)</span><span class="comment">//1.调用cprintf</span></span><br><span class="line">&#123;</span><br><span class="line">	va_list ap;<span class="comment">//参数列表</span></span><br><span class="line">	<span class="type">int</span> cnt;</span><br><span class="line"></span><br><span class="line">	va_start(ap, fmt);<span class="comment">//把xyz这样的参数使用ap指向</span></span><br><span class="line">	cnt = vcprintf(fmt, ap);<span class="comment">//传入格式，参数列表</span></span><br><span class="line">	va_end(ap);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="lib-x2F-printfmt-c"><a href="#lib-x2F-printfmt-c" class="headerlink" title="lib&#x2F;printfmt.c"></a>lib&#x2F;printfmt.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 分析输出格式：词法分析的感觉，根据格式要求来决定参数的合法判定，输出格式</span></span><br><span class="line"><span class="comment">// 常见于printf, sprintf, fprintf, etc.</span></span><br><span class="line"><span class="comment">// 内核态和用户态都有调用</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/error.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Space or zero padding and a field width are supported for the numeric</span></span><br><span class="line"><span class="comment"> * formats only.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The special format %e takes an integer error code</span></span><br><span class="line"><span class="comment"> * and prints a string describing the error.</span></span><br><span class="line"><span class="comment"> * The integer may be positive or negative,</span></span><br><span class="line"><span class="comment"> * so that -E_NO_MEM and E_NO_MEM are equivalent.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> error_string[MAXERROR] =</span><br><span class="line">&#123;</span><br><span class="line">	[E_UNSPECIFIED]	= <span class="string">&quot;unspecified error&quot;</span>,</span><br><span class="line">	[E_BAD_ENV]	= <span class="string">&quot;bad environment&quot;</span>,</span><br><span class="line">	[E_INVAL]	= <span class="string">&quot;invalid parameter&quot;</span>,</span><br><span class="line">	[E_NO_MEM]	= <span class="string">&quot;out of memory&quot;</span>,</span><br><span class="line">	[E_NO_FREE_ENV]	= <span class="string">&quot;out of environments&quot;</span>,</span><br><span class="line">	[E_FAULT]	= <span class="string">&quot;segmentation fault&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Print a number (base &lt;= 16) in reverse order,</span></span><br><span class="line"><span class="comment"> * using specified putch function and associated pointer putdat.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">printnum</span><span class="params">(<span class="type">void</span> (*putch)(<span class="type">int</span>, <span class="type">void</span>*), <span class="type">void</span> *putdat,</span></span><br><span class="line"><span class="params">	 <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> num, <span class="type">unsigned</span> base, <span class="type">int</span> width, <span class="type">int</span> padc)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// first recursively print all preceding (more significant) digits</span></span><br><span class="line">	<span class="keyword">if</span> (num &gt;= base) &#123;</span><br><span class="line">		printnum(putch, putdat, num / base, base, width - <span class="number">1</span>, padc);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// print any needed pad characters before first digit</span></span><br><span class="line">		<span class="keyword">while</span> (--width &gt; <span class="number">0</span>)</span><br><span class="line">			putch(padc, putdat);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// then print this (the least significant) digit</span></span><br><span class="line">	putch(<span class="string">&quot;0123456789abcdef&quot;</span>[num % base], putdat);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get an unsigned int of various possible sizes from a varargs list,</span></span><br><span class="line"><span class="comment">// depending on the lflag parameter.</span></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span></span><br><span class="line"><span class="title function_">getuint</span><span class="params">(va_list *ap, <span class="type">int</span> lflag)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (lflag &gt;= <span class="number">2</span>)</span><br><span class="line">		<span class="keyword">return</span> va_arg(*ap, <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>);</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (lflag)</span><br><span class="line">		<span class="keyword">return</span> va_arg(*ap, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> va_arg(*ap, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Same as getuint but signed - can&#x27;t use getuint</span></span><br><span class="line"><span class="comment">// because of sign extension</span></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="type">long</span><span class="comment">//被调用，来解决诸如%d匹配参数的问题，隐性进行合法判定</span></span><br><span class="line">getint(va_list *ap, <span class="type">int</span> lflag)<span class="comment">//ap:1,3,4</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (lflag &gt;= <span class="number">2</span>)</span><br><span class="line">		<span class="keyword">return</span> va_arg(*ap, <span class="type">long</span> <span class="type">long</span>);<span class="comment">//ap:3,4</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (lflag)</span><br><span class="line">		<span class="keyword">return</span> va_arg(*ap, <span class="type">long</span>);<span class="comment">//ap:4</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> va_arg(*ap, <span class="type">int</span>);<span class="comment">//ap:null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 格式化，并且调用putchar输出字符串</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">printfmt</span><span class="params">(<span class="type">void</span> (*putch)(<span class="type">int</span>, <span class="type">void</span>*), <span class="type">void</span> *putdat, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span>;<span class="comment">//参数：putch,&amp;cnt,fmt,ap</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">vprintfmt</span><span class="params">(<span class="type">void</span> (*putch)(<span class="type">int</span>, <span class="type">void</span>*), <span class="type">void</span> *putdat, <span class="type">const</span> <span class="type">char</span> *fmt, va_list ap)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">register</span> <span class="type">const</span> <span class="type">char</span> *p;</span><br><span class="line">	<span class="keyword">register</span> <span class="type">int</span> ch, err;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> num;</span><br><span class="line">	<span class="type">int</span> base, lflag, width, precision, altflag;</span><br><span class="line">	<span class="type">char</span> padc;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">	<span class="comment">//逐字符分析fmt：根据%后的字符决定参数，将ap参数逐步加入划分中，题例划分：&quot;x %d, y %x, z %d\n&quot;, 1, 3, 4 =&gt; &quot;x %d:1, y %x:2, z %d:3&quot; &quot;\n&quot;四个部分</span></span><br><span class="line">		<span class="keyword">while</span> ((ch = *(<span class="type">unsigned</span> <span class="type">char</span> *) fmt++) != <span class="string">&#x27;%&#x27;</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (ch == <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			putch(ch, putdat);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Process a %-escape sequence</span></span><br><span class="line">		padc = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">		width = <span class="number">-1</span>;</span><br><span class="line">		precision = <span class="number">-1</span>;</span><br><span class="line">		lflag = <span class="number">0</span>;</span><br><span class="line">		altflag = <span class="number">0</span>;</span><br><span class="line">	reswitch:</span><br><span class="line">		<span class="keyword">switch</span> (ch = *(<span class="type">unsigned</span> <span class="type">char</span> *) fmt++) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// flag to pad on the right</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">			padc = <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">			<span class="keyword">goto</span> reswitch;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// flag to pad with 0&#x27;s instead of spaces</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;0&#x27;</span>:</span><br><span class="line">			padc = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">			<span class="keyword">goto</span> reswitch;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// width field</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;4&#x27;</span>:</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;5&#x27;</span>:</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;6&#x27;</span>:</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;7&#x27;</span>:</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;8&#x27;</span>:</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;9&#x27;</span>:</span><br><span class="line">			<span class="keyword">for</span> (precision = <span class="number">0</span>; ; ++fmt) &#123;</span><br><span class="line">				precision = precision * <span class="number">10</span> + ch - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">				ch = *fmt;</span><br><span class="line">				<span class="keyword">if</span> (ch &lt; <span class="string">&#x27;0&#x27;</span> || ch &gt; <span class="string">&#x27;9&#x27;</span>)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">goto</span> process_precision;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;*&#x27;</span>:</span><br><span class="line">			precision = va_arg(ap, <span class="type">int</span>);</span><br><span class="line">			<span class="keyword">goto</span> process_precision;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;.&#x27;</span>:</span><br><span class="line">			<span class="keyword">if</span> (width &lt; <span class="number">0</span>)</span><br><span class="line">				width = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">goto</span> reswitch;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;#&#x27;</span>:</span><br><span class="line">			altflag = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">goto</span> reswitch;</span><br><span class="line"></span><br><span class="line">		process_precision:</span><br><span class="line">			<span class="keyword">if</span> (width &lt; <span class="number">0</span>)</span><br><span class="line">				width = precision, precision = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">goto</span> reswitch;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// long flag (doubled for long long)</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;l&#x27;</span>:</span><br><span class="line">			lflag++;</span><br><span class="line">			<span class="keyword">goto</span> reswitch;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// character</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">			putch(va_arg(ap, <span class="type">int</span>), putdat);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// error message</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;e&#x27;</span>:</span><br><span class="line">			err = va_arg(ap, <span class="type">int</span>);</span><br><span class="line">			<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">				err = -err;</span><br><span class="line">			<span class="keyword">if</span> (err &gt;= MAXERROR || (p = error_string[err]) == <span class="literal">NULL</span>)</span><br><span class="line">				printfmt(putch, putdat, <span class="string">&quot;error %d&quot;</span>, err);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				printfmt(putch, putdat, <span class="string">&quot;%s&quot;</span>, p);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// string</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">			<span class="keyword">if</span> ((p = va_arg(ap, <span class="type">char</span> *)) == <span class="literal">NULL</span>)</span><br><span class="line">				p = <span class="string">&quot;(null)&quot;</span>;</span><br><span class="line">			<span class="keyword">if</span> (width &gt; <span class="number">0</span> &amp;&amp; padc != <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">				<span class="keyword">for</span> (width -= strnlen(p, precision); width &gt; <span class="number">0</span>; width--)</span><br><span class="line">					putch(padc, putdat);</span><br><span class="line">			<span class="keyword">for</span> (; (ch = *p++) != <span class="string">&#x27;\0&#x27;</span> &amp;&amp; (precision &lt; <span class="number">0</span> || --precision &gt;= <span class="number">0</span>); width--)</span><br><span class="line">				<span class="keyword">if</span> (altflag &amp;&amp; (ch &lt; <span class="string">&#x27; &#x27;</span> || ch &gt; <span class="string">&#x27;~&#x27;</span>))</span><br><span class="line">					putch(<span class="string">&#x27;?&#x27;</span>, putdat);</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					putch(ch, putdat);</span><br><span class="line">			<span class="keyword">for</span> (; width &gt; <span class="number">0</span>; width--)</span><br><span class="line">				putch(<span class="string">&#x27; &#x27;</span>, putdat);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// (signed) decimal</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">			num = getint(&amp;ap, lflag);</span><br><span class="line">			<span class="keyword">if</span> ((<span class="type">long</span> <span class="type">long</span>) num &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				putch(<span class="string">&#x27;-&#x27;</span>, putdat);</span><br><span class="line">				num = -(<span class="type">long</span> <span class="type">long</span>) num;</span><br><span class="line">			&#125;</span><br><span class="line">			base = <span class="number">10</span>;</span><br><span class="line">			<span class="keyword">goto</span> number;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// unsigned decimal</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;u&#x27;</span>:</span><br><span class="line">			num = getuint(&amp;ap, lflag);</span><br><span class="line">			base = <span class="number">10</span>;</span><br><span class="line">			<span class="keyword">goto</span> number;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// (unsigned) octal</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;o&#x27;</span>:</span><br><span class="line">			<span class="comment">// Replace this with your code.</span></span><br><span class="line">			putch(<span class="string">&#x27;X&#x27;</span>, putdat);</span><br><span class="line">			putch(<span class="string">&#x27;X&#x27;</span>, putdat);</span><br><span class="line">			putch(<span class="string">&#x27;X&#x27;</span>, putdat);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// pointer</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">			putch(<span class="string">&#x27;0&#x27;</span>, putdat);</span><br><span class="line">			putch(<span class="string">&#x27;x&#x27;</span>, putdat);</span><br><span class="line">			num = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)</span><br><span class="line">				(<span class="type">uintptr_t</span>) va_arg(ap, <span class="type">void</span> *);</span><br><span class="line">			base = <span class="number">16</span>;</span><br><span class="line">			<span class="keyword">goto</span> number;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// (unsigned) hexadecimal</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">			num = getuint(&amp;ap, lflag);</span><br><span class="line">			base = <span class="number">16</span>;</span><br><span class="line">		number:</span><br><span class="line">			printnum(putch, putdat, num, base, width, padc);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// escaped &#x27;%&#x27; character</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;%&#x27;</span>:</span><br><span class="line">			putch(ch, putdat);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// unrecognized escape sequence - just print it literally</span></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			putch(<span class="string">&#x27;%&#x27;</span>, putdat);</span><br><span class="line">			<span class="keyword">for</span> (fmt--; fmt[<span class="number">-1</span>] != <span class="string">&#x27;%&#x27;</span>; fmt--)</span><br><span class="line">				<span class="comment">/* do nothing */</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">printfmt</span><span class="params">(<span class="type">void</span> (*putch)(<span class="type">int</span>, <span class="type">void</span>*), <span class="type">void</span> *putdat, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">	va_list ap;</span><br><span class="line"></span><br><span class="line">	va_start(ap, fmt);</span><br><span class="line">	vprintfmt(putch, putdat, fmt, ap);</span><br><span class="line">	va_end(ap);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sprintbuf</span> &#123;</span></span><br><span class="line">	<span class="type">char</span> *buf;</span><br><span class="line">	<span class="type">char</span> *ebuf;</span><br><span class="line">	<span class="type">int</span> cnt;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">sprintputch</span><span class="params">(<span class="type">int</span> ch, <span class="keyword">struct</span> sprintbuf *b)</span></span><br><span class="line">&#123;</span><br><span class="line">	b-&gt;cnt++;</span><br><span class="line">	<span class="keyword">if</span> (b-&gt;buf &lt; b-&gt;ebuf)</span><br><span class="line">		*b-&gt;buf++ = ch;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">vsnprintf</span><span class="params">(<span class="type">char</span> *buf, <span class="type">int</span> n, <span class="type">const</span> <span class="type">char</span> *fmt, va_list ap)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sprintbuf</span> <span class="title">b</span> =</span> &#123;buf, buf+n<span class="number">-1</span>, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (buf == <span class="literal">NULL</span> || n &lt; <span class="number">1</span>)</span><br><span class="line">		<span class="keyword">return</span> -E_INVAL;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// print the string to the buffer</span></span><br><span class="line">	vprintfmt((<span class="type">void</span>*)sprintputch, &amp;b, fmt, ap);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// null terminate the buffer</span></span><br><span class="line">	*b.buf = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> b.cnt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">snprintf</span><span class="params">(<span class="type">char</span> *buf, <span class="type">int</span> n, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">	va_list ap;</span><br><span class="line">	<span class="type">int</span> rc;</span><br><span class="line"></span><br><span class="line">	va_start(ap, fmt);</span><br><span class="line">	rc = vsnprintf(buf, n, fmt, ap);</span><br><span class="line">	va_end(ap);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Kern-x2F-console-c"><a href="#Kern-x2F-console-c" class="headerlink" title="Kern&#x2F;console.c"></a>Kern&#x2F;console.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* See COPYRIGHT for copyright information. */</span></span><br><span class="line"><span class="comment">//控制台的IO处理逻辑：I，O，控制台</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/x86.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/memlayout.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/kbdreg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;kern/console.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">cons_intr</span><span class="params">(<span class="type">int</span> (*proc)(<span class="type">void</span>))</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">cons_putc</span><span class="params">(<span class="type">int</span> c)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PC设计历史原因，只是单纯的IO等待</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">delay</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	inb(<span class="number">0x84</span>);</span><br><span class="line">	inb(<span class="number">0x84</span>);</span><br><span class="line">	inb(<span class="number">0x84</span>);</span><br><span class="line">	inb(<span class="number">0x84</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***** IO代码 *****/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COM1		0x3F8</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COM_RX		0	<span class="comment">// In:	Receive buffer (DLAB=0)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COM_TX		0	<span class="comment">// Out: Transmit buffer (DLAB=0)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COM_DLL		0	<span class="comment">// Out: Divisor Latch Low (DLAB=1)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COM_DLM		1	<span class="comment">// Out: Divisor Latch High (DLAB=1)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COM_IER		1	<span class="comment">// Out: Interrupt Enable Register</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>   COM_IER_RDI	0x01	<span class="comment">//   Enable receiver data interrupt</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COM_IIR		2	<span class="comment">// In:	Interrupt ID Register</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COM_FCR		2	<span class="comment">// Out: FIFO Control Register</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COM_LCR		3	<span class="comment">// Out: Line Control Register</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	  COM_LCR_DLAB	0x80	<span class="comment">//   Divisor latch access bit</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	  COM_LCR_WLEN8	0x03	<span class="comment">//   Wordlength: 8 bits</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COM_MCR		4	<span class="comment">// Out: Modem Control Register</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	  COM_MCR_RTS	0x02	<span class="comment">// RTS complement</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	  COM_MCR_DTR	0x01	<span class="comment">// DTR complement</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	  COM_MCR_OUT2	0x08	<span class="comment">// Out2 complement</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COM_LSR		5	<span class="comment">// In:	Line Status Register</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>   COM_LSR_DATA	0x01	<span class="comment">//   Data available</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>   COM_LSR_TXRDY	0x20	<span class="comment">//   Transmit buffer avail</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>   COM_LSR_TSRE	0x40	<span class="comment">//   Transmitter off</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> serial_exists;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">serial_proc_data</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!(inb(COM1+COM_LSR) &amp; COM_LSR_DATA))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">return</span> inb(COM1+COM_RX);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">serial_intr</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (serial_exists)</span><br><span class="line">		cons_intr(serial_proc_data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">serial_putc</span><span class="params">(<span class="type">int</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>;</span><br><span class="line">	     !(inb(COM1 + COM_LSR) &amp; COM_LSR_TXRDY) &amp;&amp; i &lt; <span class="number">12800</span>;</span><br><span class="line">	     i++)</span><br><span class="line">		delay();</span><br><span class="line"></span><br><span class="line">	outb(COM1 + COM_TX, c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">serial_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Turn off the FIFO</span></span><br><span class="line">	outb(COM1+COM_FCR, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set speed; requires DLAB latch</span></span><br><span class="line">	outb(COM1+COM_LCR, COM_LCR_DLAB);</span><br><span class="line">	outb(COM1+COM_DLL, (<span class="type">uint8_t</span>) (<span class="number">115200</span> / <span class="number">9600</span>));</span><br><span class="line">	outb(COM1+COM_DLM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 8 data bits, 1 stop bit, parity off; turn off DLAB latch</span></span><br><span class="line">	outb(COM1+COM_LCR, COM_LCR_WLEN8 &amp; ~COM_LCR_DLAB);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// No modem controls</span></span><br><span class="line">	outb(COM1+COM_MCR, <span class="number">0</span>);</span><br><span class="line">	<span class="comment">// Enable rcv interrupts</span></span><br><span class="line">	outb(COM1+COM_IER, COM_IER_RDI);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Clear any preexisting overrun indications and interrupts</span></span><br><span class="line">	<span class="comment">// Serial port doesn&#x27;t exist if COM_LSR returns 0xFF</span></span><br><span class="line">	serial_exists = (inb(COM1+COM_LSR) != <span class="number">0xFF</span>);</span><br><span class="line">	(<span class="type">void</span>) inb(COM1+COM_IIR);</span><br><span class="line">	(<span class="type">void</span>) inb(COM1+COM_RX);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/***** 并行端口输出代码 *****/</span></span><br><span class="line"><span class="comment">// For information on PC parallel port programming, see the class References</span></span><br><span class="line"><span class="comment">// page.</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">lpt_putc</span><span class="params">(<span class="type">int</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; !(inb(<span class="number">0x378</span>+<span class="number">1</span>) &amp; <span class="number">0x80</span>) &amp;&amp; i &lt; <span class="number">12800</span>; i++)</span><br><span class="line">		delay();</span><br><span class="line">	outb(<span class="number">0x378</span>+<span class="number">0</span>, c);</span><br><span class="line">	outb(<span class="number">0x378</span>+<span class="number">2</span>, <span class="number">0x08</span>|<span class="number">0x04</span>|<span class="number">0x01</span>);</span><br><span class="line">	outb(<span class="number">0x378</span>+<span class="number">2</span>, <span class="number">0x08</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/***** 以文字形式向 CGA/VGA 显示输出 *****/</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> addr_6845;</span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> *crt_buf;</span><br><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> crt_pos;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">cga_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">volatile</span> <span class="type">uint16_t</span> *cp;</span><br><span class="line">	<span class="type">uint16_t</span> was;</span><br><span class="line">	<span class="type">unsigned</span> pos;</span><br><span class="line"></span><br><span class="line">	cp = (<span class="type">uint16_t</span>*) (KERNBASE + CGA_BUF);</span><br><span class="line">	was = *cp;</span><br><span class="line">	*cp = (<span class="type">uint16_t</span>) <span class="number">0xA55A</span>;</span><br><span class="line">	<span class="keyword">if</span> (*cp != <span class="number">0xA55A</span>) &#123;</span><br><span class="line">		cp = (<span class="type">uint16_t</span>*) (KERNBASE + MONO_BUF);</span><br><span class="line">		addr_6845 = MONO_BASE;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		*cp = was;</span><br><span class="line">		addr_6845 = CGA_BASE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Extract cursor location */</span></span><br><span class="line">	outb(addr_6845, <span class="number">14</span>);</span><br><span class="line">	pos = inb(addr_6845 + <span class="number">1</span>) &lt;&lt; <span class="number">8</span>;</span><br><span class="line">	outb(addr_6845, <span class="number">15</span>);</span><br><span class="line">	pos |= inb(addr_6845 + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	crt_buf = (<span class="type">uint16_t</span>*) cp;</span><br><span class="line">	crt_pos = pos;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">cga_putc</span><span class="params">(<span class="type">int</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// if no attribute given, then use black on white</span></span><br><span class="line">	<span class="keyword">if</span> (!(c &amp; ~<span class="number">0xFF</span>))</span><br><span class="line">		c |= <span class="number">0x0700</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (c &amp; <span class="number">0xff</span>) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;\b&#x27;</span>:</span><br><span class="line">		<span class="keyword">if</span> (crt_pos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			crt_pos--;</span><br><span class="line">			crt_buf[crt_pos] = (c &amp; ~<span class="number">0xff</span>) | <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;\n&#x27;</span>:</span><br><span class="line">		crt_pos += CRT_COLS;</span><br><span class="line">		<span class="comment">/* fallthru */</span></span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;\r&#x27;</span>:</span><br><span class="line">		crt_pos -= (crt_pos % CRT_COLS);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;\t&#x27;</span>:</span><br><span class="line">		cons_putc(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">		cons_putc(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">		cons_putc(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">		cons_putc(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">		cons_putc(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		crt_buf[crt_pos++] = c;		<span class="comment">/* write the character */</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// What is the purpose of this?</span></span><br><span class="line">	<span class="keyword">if</span> (crt_pos &gt;= CRT_SIZE) &#123;</span><br><span class="line">		<span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">		memmove(crt_buf, crt_buf + CRT_COLS, (CRT_SIZE - CRT_COLS) * <span class="keyword">sizeof</span>(<span class="type">uint16_t</span>));</span><br><span class="line">		<span class="keyword">for</span> (i = CRT_SIZE - CRT_COLS; i &lt; CRT_SIZE; i++)</span><br><span class="line">			crt_buf[i] = <span class="number">0x0700</span> | <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">		crt_pos -= CRT_COLS;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* move that little blinky thing */</span></span><br><span class="line">	outb(addr_6845, <span class="number">14</span>);</span><br><span class="line">	outb(addr_6845 + <span class="number">1</span>, crt_pos &gt;&gt; <span class="number">8</span>);</span><br><span class="line">	outb(addr_6845, <span class="number">15</span>);</span><br><span class="line">	outb(addr_6845 + <span class="number">1</span>, crt_pos);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/***** 键盘输入处理 *****/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NO		0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHIFT		(1&lt;&lt;0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CTL		(1&lt;&lt;1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALT		(1&lt;&lt;2)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAPSLOCK	(1&lt;&lt;3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUMLOCK		(1&lt;&lt;4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCROLLLOCK	(1&lt;&lt;5)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> E0ESC		(1&lt;&lt;6)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> shiftcode[<span class="number">256</span>] =</span><br><span class="line">&#123;</span><br><span class="line">	[<span class="number">0x1D</span>] = CTL,</span><br><span class="line">	[<span class="number">0x2A</span>] = SHIFT,</span><br><span class="line">	[<span class="number">0x36</span>] = SHIFT,</span><br><span class="line">	[<span class="number">0x38</span>] = ALT,</span><br><span class="line">	[<span class="number">0x9D</span>] = CTL,</span><br><span class="line">	[<span class="number">0xB8</span>] = ALT</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> togglecode[<span class="number">256</span>] =</span><br><span class="line">&#123;</span><br><span class="line">	[<span class="number">0x3A</span>] = CAPSLOCK,</span><br><span class="line">	[<span class="number">0x45</span>] = NUMLOCK,</span><br><span class="line">	[<span class="number">0x46</span>] = SCROLLLOCK</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> normalmap[<span class="number">256</span>] =</span><br><span class="line">&#123;</span><br><span class="line">	NO,   <span class="number">0x1B</span>, <span class="string">&#x27;1&#x27;</span>,  <span class="string">&#x27;2&#x27;</span>,  <span class="string">&#x27;3&#x27;</span>,  <span class="string">&#x27;4&#x27;</span>,  <span class="string">&#x27;5&#x27;</span>,  <span class="string">&#x27;6&#x27;</span>,	<span class="comment">// 0x00</span></span><br><span class="line">	<span class="string">&#x27;7&#x27;</span>,  <span class="string">&#x27;8&#x27;</span>,  <span class="string">&#x27;9&#x27;</span>,  <span class="string">&#x27;0&#x27;</span>,  <span class="string">&#x27;-&#x27;</span>,  <span class="string">&#x27;=&#x27;</span>,  <span class="string">&#x27;\b&#x27;</span>, <span class="string">&#x27;\t&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;q&#x27;</span>,  <span class="string">&#x27;w&#x27;</span>,  <span class="string">&#x27;e&#x27;</span>,  <span class="string">&#x27;r&#x27;</span>,  <span class="string">&#x27;t&#x27;</span>,  <span class="string">&#x27;y&#x27;</span>,  <span class="string">&#x27;u&#x27;</span>,  <span class="string">&#x27;i&#x27;</span>,	<span class="comment">// 0x10</span></span><br><span class="line">	<span class="string">&#x27;o&#x27;</span>,  <span class="string">&#x27;p&#x27;</span>,  <span class="string">&#x27;[&#x27;</span>,  <span class="string">&#x27;]&#x27;</span>,  <span class="string">&#x27;\n&#x27;</span>, NO,   <span class="string">&#x27;a&#x27;</span>,  <span class="string">&#x27;s&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;d&#x27;</span>,  <span class="string">&#x27;f&#x27;</span>,  <span class="string">&#x27;g&#x27;</span>,  <span class="string">&#x27;h&#x27;</span>,  <span class="string">&#x27;j&#x27;</span>,  <span class="string">&#x27;k&#x27;</span>,  <span class="string">&#x27;l&#x27;</span>,  <span class="string">&#x27;;&#x27;</span>,	<span class="comment">// 0x20</span></span><br><span class="line">	<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;`&#x27;</span>,  NO,   <span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;z&#x27;</span>,  <span class="string">&#x27;x&#x27;</span>,  <span class="string">&#x27;c&#x27;</span>,  <span class="string">&#x27;v&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;b&#x27;</span>,  <span class="string">&#x27;n&#x27;</span>,  <span class="string">&#x27;m&#x27;</span>,  <span class="string">&#x27;,&#x27;</span>,  <span class="string">&#x27;.&#x27;</span>,  <span class="string">&#x27;/&#x27;</span>,  NO,   <span class="string">&#x27;*&#x27;</span>,	<span class="comment">// 0x30</span></span><br><span class="line">	NO,   <span class="string">&#x27; &#x27;</span>,  NO,   NO,   NO,   NO,   NO,   NO,</span><br><span class="line">	NO,   NO,   NO,   NO,   NO,   NO,   NO,   <span class="string">&#x27;7&#x27;</span>,	<span class="comment">// 0x40</span></span><br><span class="line">	<span class="string">&#x27;8&#x27;</span>,  <span class="string">&#x27;9&#x27;</span>,  <span class="string">&#x27;-&#x27;</span>,  <span class="string">&#x27;4&#x27;</span>,  <span class="string">&#x27;5&#x27;</span>,  <span class="string">&#x27;6&#x27;</span>,  <span class="string">&#x27;+&#x27;</span>,  <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;2&#x27;</span>,  <span class="string">&#x27;3&#x27;</span>,  <span class="string">&#x27;0&#x27;</span>,  <span class="string">&#x27;.&#x27;</span>,  NO,   NO,   NO,   NO,	<span class="comment">// 0x50</span></span><br><span class="line">	[<span class="number">0xC7</span>] = KEY_HOME,	      [<span class="number">0x9C</span>] = <span class="string">&#x27;\n&#x27;</span> <span class="comment">/*KP_Enter*/</span>,</span><br><span class="line">	[<span class="number">0xB5</span>] = <span class="string">&#x27;/&#x27;</span> <span class="comment">/*KP_Div*/</span>,      [<span class="number">0xC8</span>] = KEY_UP,</span><br><span class="line">	[<span class="number">0xC9</span>] = KEY_PGUP,	      [<span class="number">0xCB</span>] = KEY_LF,</span><br><span class="line">	[<span class="number">0xCD</span>] = KEY_RT,	      [<span class="number">0xCF</span>] = KEY_END,</span><br><span class="line">	[<span class="number">0xD0</span>] = KEY_DN,	      [<span class="number">0xD1</span>] = KEY_PGDN,</span><br><span class="line">	[<span class="number">0xD2</span>] = KEY_INS,	      [<span class="number">0xD3</span>] = KEY_DEL</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> shiftmap[<span class="number">256</span>] =</span><br><span class="line">&#123;</span><br><span class="line">	NO,   <span class="number">033</span>,  <span class="string">&#x27;!&#x27;</span>,  <span class="string">&#x27;@&#x27;</span>,  <span class="string">&#x27;#&#x27;</span>,  <span class="string">&#x27;$&#x27;</span>,  <span class="string">&#x27;%&#x27;</span>,  <span class="string">&#x27;^&#x27;</span>,	<span class="comment">// 0x00</span></span><br><span class="line">	<span class="string">&#x27;&amp;&#x27;</span>,  <span class="string">&#x27;*&#x27;</span>,  <span class="string">&#x27;(&#x27;</span>,  <span class="string">&#x27;)&#x27;</span>,  <span class="string">&#x27;_&#x27;</span>,  <span class="string">&#x27;+&#x27;</span>,  <span class="string">&#x27;\b&#x27;</span>, <span class="string">&#x27;\t&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;Q&#x27;</span>,  <span class="string">&#x27;W&#x27;</span>,  <span class="string">&#x27;E&#x27;</span>,  <span class="string">&#x27;R&#x27;</span>,  <span class="string">&#x27;T&#x27;</span>,  <span class="string">&#x27;Y&#x27;</span>,  <span class="string">&#x27;U&#x27;</span>,  <span class="string">&#x27;I&#x27;</span>,	<span class="comment">// 0x10</span></span><br><span class="line">	<span class="string">&#x27;O&#x27;</span>,  <span class="string">&#x27;P&#x27;</span>,  <span class="string">&#x27;&#123;&#x27;</span>,  <span class="string">&#x27;&#125;&#x27;</span>,  <span class="string">&#x27;\n&#x27;</span>, NO,   <span class="string">&#x27;A&#x27;</span>,  <span class="string">&#x27;S&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;D&#x27;</span>,  <span class="string">&#x27;F&#x27;</span>,  <span class="string">&#x27;G&#x27;</span>,  <span class="string">&#x27;H&#x27;</span>,  <span class="string">&#x27;J&#x27;</span>,  <span class="string">&#x27;K&#x27;</span>,  <span class="string">&#x27;L&#x27;</span>,  <span class="string">&#x27;:&#x27;</span>,	<span class="comment">// 0x20</span></span><br><span class="line">	<span class="string">&#x27;&quot;&#x27;</span>,  <span class="string">&#x27;~&#x27;</span>,  NO,   <span class="string">&#x27;|&#x27;</span>,  <span class="string">&#x27;Z&#x27;</span>,  <span class="string">&#x27;X&#x27;</span>,  <span class="string">&#x27;C&#x27;</span>,  <span class="string">&#x27;V&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;B&#x27;</span>,  <span class="string">&#x27;N&#x27;</span>,  <span class="string">&#x27;M&#x27;</span>,  <span class="string">&#x27;&lt;&#x27;</span>,  <span class="string">&#x27;&gt;&#x27;</span>,  <span class="string">&#x27;?&#x27;</span>,  NO,   <span class="string">&#x27;*&#x27;</span>,	<span class="comment">// 0x30</span></span><br><span class="line">	NO,   <span class="string">&#x27; &#x27;</span>,  NO,   NO,   NO,   NO,   NO,   NO,</span><br><span class="line">	NO,   NO,   NO,   NO,   NO,   NO,   NO,   <span class="string">&#x27;7&#x27;</span>,	<span class="comment">// 0x40</span></span><br><span class="line">	<span class="string">&#x27;8&#x27;</span>,  <span class="string">&#x27;9&#x27;</span>,  <span class="string">&#x27;-&#x27;</span>,  <span class="string">&#x27;4&#x27;</span>,  <span class="string">&#x27;5&#x27;</span>,  <span class="string">&#x27;6&#x27;</span>,  <span class="string">&#x27;+&#x27;</span>,  <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;2&#x27;</span>,  <span class="string">&#x27;3&#x27;</span>,  <span class="string">&#x27;0&#x27;</span>,  <span class="string">&#x27;.&#x27;</span>,  NO,   NO,   NO,   NO,	<span class="comment">// 0x50</span></span><br><span class="line">	[<span class="number">0xC7</span>] = KEY_HOME,	      [<span class="number">0x9C</span>] = <span class="string">&#x27;\n&#x27;</span> <span class="comment">/*KP_Enter*/</span>,</span><br><span class="line">	[<span class="number">0xB5</span>] = <span class="string">&#x27;/&#x27;</span> <span class="comment">/*KP_Div*/</span>,      [<span class="number">0xC8</span>] = KEY_UP,</span><br><span class="line">	[<span class="number">0xC9</span>] = KEY_PGUP,	      [<span class="number">0xCB</span>] = KEY_LF,</span><br><span class="line">	[<span class="number">0xCD</span>] = KEY_RT,	      [<span class="number">0xCF</span>] = KEY_END,</span><br><span class="line">	[<span class="number">0xD0</span>] = KEY_DN,	      [<span class="number">0xD1</span>] = KEY_PGDN,</span><br><span class="line">	[<span class="number">0xD2</span>] = KEY_INS,	      [<span class="number">0xD3</span>] = KEY_DEL</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> C(x) (x - <span class="string">&#x27;@&#x27;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> ctlmap[<span class="number">256</span>] =</span><br><span class="line">&#123;</span><br><span class="line">	NO,      NO,      NO,      NO,      NO,      NO,      NO,      NO,</span><br><span class="line">	NO,      NO,      NO,      NO,      NO,      NO,      NO,      NO,</span><br><span class="line">	C(<span class="string">&#x27;Q&#x27;</span>),  C(<span class="string">&#x27;W&#x27;</span>),  C(<span class="string">&#x27;E&#x27;</span>),  C(<span class="string">&#x27;R&#x27;</span>),  C(<span class="string">&#x27;T&#x27;</span>),  C(<span class="string">&#x27;Y&#x27;</span>),  C(<span class="string">&#x27;U&#x27;</span>),  C(<span class="string">&#x27;I&#x27;</span>),</span><br><span class="line">	C(<span class="string">&#x27;O&#x27;</span>),  C(<span class="string">&#x27;P&#x27;</span>),  NO,      NO,      <span class="string">&#x27;\r&#x27;</span>,    NO,      C(<span class="string">&#x27;A&#x27;</span>),  C(<span class="string">&#x27;S&#x27;</span>),</span><br><span class="line">	C(<span class="string">&#x27;D&#x27;</span>),  C(<span class="string">&#x27;F&#x27;</span>),  C(<span class="string">&#x27;G&#x27;</span>),  C(<span class="string">&#x27;H&#x27;</span>),  C(<span class="string">&#x27;J&#x27;</span>),  C(<span class="string">&#x27;K&#x27;</span>),  C(<span class="string">&#x27;L&#x27;</span>),  NO,</span><br><span class="line">	NO,      NO,      NO,      C(<span class="string">&#x27;\\&#x27;</span>), C(<span class="string">&#x27;Z&#x27;</span>),  C(<span class="string">&#x27;X&#x27;</span>),  C(<span class="string">&#x27;C&#x27;</span>),  C(<span class="string">&#x27;V&#x27;</span>),</span><br><span class="line">	C(<span class="string">&#x27;B&#x27;</span>),  C(<span class="string">&#x27;N&#x27;</span>),  C(<span class="string">&#x27;M&#x27;</span>),  NO,      NO,      C(<span class="string">&#x27;/&#x27;</span>),  NO,      NO,</span><br><span class="line">	[<span class="number">0x97</span>] = KEY_HOME,</span><br><span class="line">	[<span class="number">0xB5</span>] = C(<span class="string">&#x27;/&#x27;</span>),		[<span class="number">0xC8</span>] = KEY_UP,</span><br><span class="line">	[<span class="number">0xC9</span>] = KEY_PGUP,		[<span class="number">0xCB</span>] = KEY_LF,</span><br><span class="line">	[<span class="number">0xCD</span>] = KEY_RT,		[<span class="number">0xCF</span>] = KEY_END,</span><br><span class="line">	[<span class="number">0xD0</span>] = KEY_DN,		[<span class="number">0xD1</span>] = KEY_PGDN,</span><br><span class="line">	[<span class="number">0xD2</span>] = KEY_INS,		[<span class="number">0xD3</span>] = KEY_DEL</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> *charcode[<span class="number">4</span>] = &#123;</span><br><span class="line">	normalmap,</span><br><span class="line">	shiftmap,</span><br><span class="line">	ctlmap,</span><br><span class="line">	ctlmap</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 从键盘获取单个字符，如果成功，返回，如果没有，返回0.</span></span><br><span class="line"><span class="comment"> * 无数据返回-1.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">kbd_proc_data</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> c;</span><br><span class="line">	<span class="type">uint8_t</span> stat, data;</span><br><span class="line">	<span class="type">static</span> <span class="type">uint32_t</span> shift;</span><br><span class="line"></span><br><span class="line">	stat = inb(KBSTATP);</span><br><span class="line">	<span class="keyword">if</span> ((stat &amp; KBS_DIB) == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="comment">// Ignore data from mouse.</span></span><br><span class="line">	<span class="keyword">if</span> (stat &amp; KBS_TERR)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	data = inb(KBDATAP);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (data == <span class="number">0xE0</span>) &#123;</span><br><span class="line">		<span class="comment">// E0 escape character</span></span><br><span class="line">		shift |= E0ESC;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (data &amp; <span class="number">0x80</span>) &#123;</span><br><span class="line">		<span class="comment">// Key released</span></span><br><span class="line">		data = (shift &amp; E0ESC ? data : data &amp; <span class="number">0x7F</span>);</span><br><span class="line">		shift &amp;= ~(shiftcode[data] | E0ESC);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (shift &amp; E0ESC) &#123;</span><br><span class="line">		<span class="comment">// Last character was an E0 escape; or with 0x80</span></span><br><span class="line">		data |= <span class="number">0x80</span>;</span><br><span class="line">		shift &amp;= ~E0ESC;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	shift |= shiftcode[data];</span><br><span class="line">	shift ^= togglecode[data];</span><br><span class="line"></span><br><span class="line">	c = charcode[shift &amp; (CTL | SHIFT)][data];</span><br><span class="line">	<span class="keyword">if</span> (shift &amp; CAPSLOCK) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="string">&#x27;a&#x27;</span> &lt;= c &amp;&amp; c &lt;= <span class="string">&#x27;z&#x27;</span>)</span><br><span class="line">			c += <span class="string">&#x27;A&#x27;</span> - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&#x27;A&#x27;</span> &lt;= c &amp;&amp; c &lt;= <span class="string">&#x27;Z&#x27;</span>)</span><br><span class="line">			c += <span class="string">&#x27;a&#x27;</span> - <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Process special keys</span></span><br><span class="line">	<span class="comment">// Ctrl-Alt-Del: reboot</span></span><br><span class="line">	<span class="keyword">if</span> (!(~shift &amp; (CTL | ALT)) &amp;&amp; c == KEY_DEL) &#123;</span><br><span class="line">		cprintf(<span class="string">&quot;Rebooting!\n&quot;</span>);</span><br><span class="line">		outb(<span class="number">0x92</span>, <span class="number">0x3</span>); <span class="comment">// courtesy of Chris Frost</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">kbd_intr</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	cons_intr(kbd_proc_data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">kbd_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/***** 设备无关的控制台代码 *****/</span></span><br><span class="line"><span class="comment">// Here we manage the console input buffer,</span></span><br><span class="line"><span class="comment">// where we stash characters received from the keyboard or serial port</span></span><br><span class="line"><span class="comment">// whenever the corresponding interrupt occurs.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONSBUFSIZE 512</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="type">uint8_t</span> buf[CONSBUFSIZE];</span><br><span class="line">	<span class="type">uint32_t</span> rpos;</span><br><span class="line">	<span class="type">uint32_t</span> wpos;</span><br><span class="line">&#125; cons;</span><br><span class="line"></span><br><span class="line"><span class="comment">// called by device interrupt routines to feed input characters</span></span><br><span class="line"><span class="comment">// into the circular console input buffer.</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">cons_intr</span><span class="params">(<span class="type">int</span> (*proc)(<span class="type">void</span>))</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> c;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> ((c = (*proc)()) != <span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		cons.buf[cons.wpos++] = c;</span><br><span class="line">		<span class="keyword">if</span> (cons.wpos == CONSBUFSIZE)</span><br><span class="line">			cons.wpos = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// return the next input character from the console, or 0 if none waiting</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">cons_getc</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> c;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// poll for any pending input characters,</span></span><br><span class="line">	<span class="comment">// so that this function works even when interrupts are disabled</span></span><br><span class="line">	<span class="comment">// (e.g., when called from the kernel monitor).</span></span><br><span class="line">	serial_intr();</span><br><span class="line">	kbd_intr();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// grab the next character from the input buffer.</span></span><br><span class="line">	<span class="keyword">if</span> (cons.rpos != cons.wpos) &#123;</span><br><span class="line">		c = cons.buf[cons.rpos++];</span><br><span class="line">		<span class="keyword">if</span> (cons.rpos == CONSBUFSIZE)</span><br><span class="line">			cons.rpos = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span> c;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output a character to the console</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">cons_putc</span><span class="params">(<span class="type">int</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">	serial_putc(c);</span><br><span class="line">	lpt_putc(c);</span><br><span class="line">	cga_putc(c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// initialize the console devices</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">cons_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	cga_init();</span><br><span class="line">	kbd_init();</span><br><span class="line">	serial_init();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!serial_exists)</span><br><span class="line">		cprintf(<span class="string">&quot;Serial port does not exist!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// `High&#x27;-level console I/O.  Used by readline and cprintf.</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">cputchar</span><span class="params">(<span class="type">int</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">	cons_putc(c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">getchar</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> c;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> ((c = cons_getc()) == <span class="number">0</span>)</span><br><span class="line">		<span class="comment">/* do nothing */</span>;</span><br><span class="line">	<span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">iscons</span><span class="params">(<span class="type">int</span> fdnum)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// used by readline</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="kern-x2F-kdebug-c"><a href="#kern-x2F-kdebug-c" class="headerlink" title="kern&#x2F;kdebug.c"></a>kern&#x2F;kdebug.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/stab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/memlayout.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;kern/kdebug.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">Stab</span> __<span class="title">STAB_BEGIN__</span>[];</span>	<span class="comment">// Beginning of stabs table</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">Stab</span> __<span class="title">STAB_END__</span>[];</span>	<span class="comment">// End of stabs table</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">const</span> <span class="type">char</span> __STABSTR_BEGIN__[];		<span class="comment">// Beginning of string table</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">const</span> <span class="type">char</span> __STABSTR_END__[];		<span class="comment">// End of string table</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Stab是一个增序的指令数组，包含了大量关于代码执行的诸如起始地址，函数名，等我们需要的信息，因此info需要stab数组来填充</span></span><br><span class="line"><span class="comment">//1.stab_binsearch(stabs, region_left, region_right, type, addr)二分搜索指令地址，查找指定代码地址信息</span></span><br><span class="line"><span class="comment">//	给以下例子，</span></span><br><span class="line"><span class="comment">//		Index  Type   Address</span></span><br><span class="line"><span class="comment">//		0      SO     f0100000</span></span><br><span class="line"><span class="comment">//		13     SO     f0100040</span></span><br><span class="line"><span class="comment">//		117    SO     f0100176</span></span><br><span class="line"><span class="comment">//		118    SO     f0100178</span></span><br><span class="line"><span class="comment">//		555    SO     f0100652</span></span><br><span class="line"><span class="comment">//		556    SO     f0100654</span></span><br><span class="line"><span class="comment">//		657    SO     f0100849</span></span><br><span class="line"><span class="comment">//	给定参数:</span></span><br><span class="line"><span class="comment">//		left = 0, right = 657;为左闭右闭边界</span></span><br><span class="line"><span class="comment">//		stab_binsearch(stabs, &amp;left, &amp;right, N_SO, 0xf0100184);</span></span><br><span class="line"><span class="comment">//	结果得到 left = 118, right = 554.，因此left是指令所在索引，right是下个指令索引，所以left&gt;right代表失败</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">stab_binsearch</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> Stab *stabs, <span class="type">int</span> *region_left, <span class="type">int</span> *region_right,</span></span><br><span class="line"><span class="params">	       <span class="type">int</span> type, <span class="type">uintptr_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> l = *region_left, r = *region_right, any_matches = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (l &lt;= r) &#123;<span class="comment">//l不同于*region_left</span></span><br><span class="line">		<span class="type">int</span> true_m = (l + r) / <span class="number">2</span>, m = true_m;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 过滤不正确的type节省时间，中间值向左偏移</span></span><br><span class="line">		<span class="keyword">while</span> (m &gt;= l &amp;&amp; stabs[m].n_type != type)</span><br><span class="line">			m--;</span><br><span class="line">		<span class="keyword">if</span> (m &lt; l) &#123;	<span class="comment">// no match in [l, m]</span></span><br><span class="line">			l = true_m + <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 实际的二分搜索代码</span></span><br><span class="line">		any_matches = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span> (stabs[m].n_value &lt; addr) &#123;</span><br><span class="line">			*region_left = m;</span><br><span class="line">			l = true_m + <span class="number">1</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (stabs[m].n_value &gt; addr) &#123;</span><br><span class="line">			*region_right = m - <span class="number">1</span>;</span><br><span class="line">			r = m - <span class="number">1</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// exact match for &#x27;addr&#x27;, but continue loop to find</span></span><br><span class="line">			<span class="comment">// *region_right</span></span><br><span class="line">			*region_left = m;</span><br><span class="line">			l = m;</span><br><span class="line">			addr++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!any_matches)</span><br><span class="line">		*region_right = *region_left - <span class="number">1</span>;<span class="comment">//非法判定成立准备</span></span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// 由于符号表中存在地址相同的可能，所以排列情况下，我们要的就是最右的那个</span></span><br><span class="line">		<span class="keyword">for</span> (l = *region_right;</span><br><span class="line">		     l &gt; *region_left &amp;&amp; stabs[l].n_type != type;</span><br><span class="line">		     l--)</span><br><span class="line">			<span class="comment">/* do nothing */</span>;</span><br><span class="line">		*region_left = l;<span class="comment">//赋值</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.debuginfo_eip调用二分搜索来填充info，成功返回0，失败返回-1，但是失败的时候，info可能也填充了一部分</span></span><br><span class="line"><span class="comment">// debuginfo_eip(addr, info)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//	Fill in the &#x27;info&#x27; structure with information about the specified</span></span><br><span class="line"><span class="comment">//	instruction address, &#x27;addr&#x27;.  Returns 0 if information was found, and</span></span><br><span class="line"><span class="comment">//	negative if not.  But even if it returns negative it has stored some</span></span><br><span class="line"><span class="comment">//	information into &#x27;*info&#x27;.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">debuginfo_eip</span><span class="params">(<span class="type">uintptr_t</span> addr, <span class="keyword">struct</span> Eipdebuginfo *info)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">Stab</span> *<span class="title">stabs</span>, *<span class="title">stab_end</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *stabstr, *stabstr_end;</span><br><span class="line">	<span class="type">int</span> lfile, rfile, lfun, rfun, lline, rline;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize *info</span></span><br><span class="line">	info-&gt;eip_file = <span class="string">&quot;&lt;unknown&gt;&quot;</span>;</span><br><span class="line">	info-&gt;eip_line = <span class="number">0</span>;</span><br><span class="line">	info-&gt;eip_fn_name = <span class="string">&quot;&lt;unknown&gt;&quot;</span>;</span><br><span class="line">	info-&gt;eip_fn_namelen = <span class="number">9</span>;</span><br><span class="line">	info-&gt;eip_fn_addr = addr;</span><br><span class="line">	info-&gt;eip_fn_narg = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Find the relevant set of stabs</span></span><br><span class="line">	<span class="keyword">if</span> (addr &gt;= ULIM) &#123;</span><br><span class="line">		stabs = __STAB_BEGIN__;</span><br><span class="line">		stab_end = __STAB_END__;</span><br><span class="line">		stabstr = __STABSTR_BEGIN__;</span><br><span class="line">		stabstr_end = __STABSTR_END__;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Can&#x27;t search for user-level addresses yet!</span></span><br><span class="line">  	        panic(<span class="string">&quot;User address&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// String table validity checks</span></span><br><span class="line">	<span class="keyword">if</span> (stabstr_end &lt;= stabstr || stabstr_end[<span class="number">-1</span>] != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Now we find the right stabs that define the function containing</span></span><br><span class="line">	<span class="comment">// &#x27;eip&#x27;.  First, we find the basic source file containing &#x27;eip&#x27;.</span></span><br><span class="line">	<span class="comment">// Then, we look in that source file for the function.  Then we look</span></span><br><span class="line">	<span class="comment">// for the line number.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Search the entire set of stabs for the source file (type N_SO).</span></span><br><span class="line">	lfile = <span class="number">0</span>;</span><br><span class="line">	rfile = (stab_end - stabs) - <span class="number">1</span>;</span><br><span class="line">	stab_binsearch(stabs, &amp;lfile, &amp;rfile, N_SO, addr);</span><br><span class="line">	<span class="keyword">if</span> (lfile == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Search within that file&#x27;s stabs for the function definition</span></span><br><span class="line">	<span class="comment">// (N_FUN).</span></span><br><span class="line">	lfun = lfile;</span><br><span class="line">	rfun = rfile;</span><br><span class="line">	stab_binsearch(stabs, &amp;lfun, &amp;rfun, N_FUN, addr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (lfun &lt;= rfun) &#123;</span><br><span class="line">		<span class="comment">// stabs[lfun] points to the function name</span></span><br><span class="line">		<span class="comment">// in the string table, but check bounds just in case.</span></span><br><span class="line">		<span class="keyword">if</span> (stabs[lfun].n_strx &lt; stabstr_end - stabstr)</span><br><span class="line">			info-&gt;eip_fn_name = stabstr + stabs[lfun].n_strx;</span><br><span class="line">		info-&gt;eip_fn_addr = stabs[lfun].n_value;</span><br><span class="line">		addr -= info-&gt;eip_fn_addr;</span><br><span class="line">		<span class="comment">// Search within the function definition for the line number.</span></span><br><span class="line">		lline = lfun;</span><br><span class="line">		rline = rfun;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Couldn&#x27;t find function stab!  Maybe we&#x27;re in an assembly</span></span><br><span class="line">		<span class="comment">// file.  Search the whole file for the line number.</span></span><br><span class="line">		info-&gt;eip_fn_addr = addr;</span><br><span class="line">		lline = lfile;</span><br><span class="line">		rline = rfile;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Ignore stuff after the colon.</span></span><br><span class="line">	info-&gt;eip_fn_namelen = strfind(info-&gt;eip_fn_name, <span class="string">&#x27;:&#x27;</span>) - info-&gt;eip_fn_name;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 给定边界[lline, rline] </span></span><br><span class="line">	<span class="comment">// 找到之后， info-&gt;eip_line 赋值为rline代码块的行数</span></span><br><span class="line">	<span class="comment">// 失败返回-1</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Hint:</span></span><br><span class="line">	<span class="comment">//	对于代码行数，stab已经有特定的字段保存，你只要给addr参数即可，不需要再计算</span></span><br><span class="line">	<span class="comment">//	从&lt;inc/stab.h&gt;找stab定义</span></span><br><span class="line">	<span class="comment">// 我的代码</span></span><br><span class="line">	stab_binsearch(stabs, &amp;lline, &amp;rline, N_SLINE, addr);<span class="comment">//代码行数</span></span><br><span class="line">	<span class="keyword">if</span> (lline &lt;= rline) &#123;</span><br><span class="line">    	info-&gt;eip_line = stabs[rline].n_desc;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> 	   <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Search backwards from the line number for the relevant filename</span></span><br><span class="line">	<span class="comment">// stab.</span></span><br><span class="line">	<span class="comment">// We can&#x27;t just use the &quot;lfile&quot; stab because inlined functions</span></span><br><span class="line">	<span class="comment">// can interpolate code from a different file!</span></span><br><span class="line">	<span class="comment">// Such included source files use the N_SOL stab type.</span></span><br><span class="line">	<span class="keyword">while</span> (lline &gt;= lfile</span><br><span class="line">	       &amp;&amp; stabs[lline].n_type != N_SOL</span><br><span class="line">	       &amp;&amp; (stabs[lline].n_type != N_SO || !stabs[lline].n_value))</span><br><span class="line">		lline--;</span><br><span class="line">	<span class="keyword">if</span> (lline &gt;= lfile &amp;&amp; stabs[lline].n_strx &lt; stabstr_end - stabstr)</span><br><span class="line">		info-&gt;eip_file = stabstr + stabs[lline].n_strx;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set eip_fn_narg to the number of arguments taken by the function,</span></span><br><span class="line">	<span class="comment">// or 0 if there was no containing function.</span></span><br><span class="line">	<span class="keyword">if</span> (lfun &lt; rfun)</span><br><span class="line">		<span class="keyword">for</span> (lline = lfun + <span class="number">1</span>;</span><br><span class="line">		     lline &lt; rfun &amp;&amp; stabs[lline].n_type == N_PSYM;</span><br><span class="line">		     lline++)</span><br><span class="line">			info-&gt;eip_fn_narg++;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
      <div id="reword-out">
        <div id="reward-btn">
          Donate
        </div>
      </div>
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>Copyright： </strong>
          Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source.
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://sakura-mac.github.io/2024/03/08/lab1/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Mit-6-828/" rel="tag">Mit-6.828</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2024/03/08/lab2/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            实验 2：内存管理
          
        </div>
      </a>
    
    
      <a href="/2024/03/08/gdb%E5%8F%AF%E8%A7%86%E5%8C%96/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">gdb可视化</div>
      </a>
    
  </nav>

   
<!-- valine评论 -->
<div id="vcomments-box">
  <div id="vcomments"></div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script>
<script>
  new Valine({
    el: "#vcomments",
    app_id: "bbzBMY2PHFRlbkSCorlYCrRX-gzGzoHsz",
    app_key: "NMnT9uDCzg2rW4ckm0fpSm5y",
    path: window.location.pathname,
    avatar: "monsterid",
    placeholder: "请留下你此刻脑海中的想法~",
    recordIP: true,
  });
  const infoEle = document.querySelector("#vcomments .info");
  if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
    infoEle.childNodes.forEach(function (item) {
      item.parentNode.removeChild(item);
    });
  }
</script>
<style>
  #vcomments-box {
    padding: 5px 30px;
  }

  @media screen and (max-width: 800px) {
    #vcomments-box {
      padding: 5px 0px;
    }
  }

  #vcomments-box #vcomments {
    background-color: #fff;
  }

  .v .vlist .vcard .vh {
    padding-right: 20px;
  }

  .v .vlist .vcard {
    padding-left: 10px;
  }
</style>

 
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2020-2024
        <i class="ri-heart-fill heart_icon"></i> 环烷烃
      </li>
    </ul>
    <ul>
      <li>
        
        
        
        Powered by <a href="https://hexo.io" target="_blank">Hexo</a>
        <span class="division">|</span>
        Theme - <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>Visitors:<span id="busuanzi_value_site_uv"></span></s>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>Views:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.jpg" alt="海猫栖息地"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/player/">播放器</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>

    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>我很可爱，请我喝一瓶怡宝吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->


<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
  var ayerConfig = {
    mathjax: true
  }
</script>

<!-- Katex -->

<!-- busuanzi  -->


<script src="/js/busuanzi-2.3.pure.min.js"></script>


<!-- ClickLove -->

<!-- ClickBoom1 -->

<script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script>

<script src="/js/clickBoom1.js"></script>


<!-- ClickBoom2 -->

<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->


    
  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":150,"height":300,"hOffset":80,"vOffset":-50},"mobile":{"show":true},"log":false});</script></body>

</html>